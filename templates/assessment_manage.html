{% extends 'base_lecdashboard.html' %}
{% block title %}Assessment Management{% endblock %}
{% block breadcrumb %}Programme > Assessment Management{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/useredit.css') }}">

<div class="profile-header">
  <h2 style="margin-left: 20px;">Assessment Management</h2>
  <div style="float: right; margin-top: -48px; margin-right: 40px;">
    <div class="cs_tooltip" style="display:inline-block; margin-right: 795px; margin-top: 3px;">
      <a href="{{ url_for('assessment_enrollment_report') }}"><i class="fas fa-chart-bar"></i></a>
      <span class="tooltiptext">Assessment Report</span>
    </div>
  </div>
</div>

<hr style="width: 100%;">

<form method="GET" action="{{ url_for('assessment_create') }}">
  <button type="submit" class="btnCreate" style="margin-left: 90%;">Create</button>
</form>

<div id="studentList">
  <table class="studentList">
    <thead>
      <tr>
        <th>No.</th>
        <th style="width: 15%;">Assessment Code</th>
        <th>Assessment Title</th>
        <th>Course(s)</th>
        <th>Edit</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for assessment in assessments %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ assessment.assessment_code }}</td>
        <td>{{ assessment.title }}</td>
        <td>
        {% if assessment.course_codes %}
            {{ assessment.course_codes | join(', ') }}
        {% else %}
            -
        {% endif %}
        </td>
        <td class="btnUpdate">
          <a href="{{ url_for('assessment_edit', assessment_code=assessment.assessment_code) }}"><i class='fas fa-edit'></i></a>
        </td>
        <td class="btnDelete">
          <a href="#" class="delete-btn"
            data-code="{{ assessment.assessment_code }}"
            data-title="{{ assessment.title }}"
            data-courses="{{ assessment.course_codes | join(', ') if assessment.course_codes else '-' }}">
            <i class='fa fa-solid fa-trash'></i>
          </a>
        </td> 
      </tr>
      {% else %}
      <tr>
        <td colspan="6" style="text-align:center;">No assessments available.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const code = this.dataset.code;
      const title = this.dataset.title;
      const courses = this.dataset.courses;

      Swal.fire({
        title: 'Delete This Assessment?',
        html: `
        <span style="color: #dc2626;">This action cannot be undone.</span>
          <table style="width:100%; font-size: 16px; text-align: left; padding-left: 80px; line-height: 1.8;">
            <tr><td style="font-weight: bold;">Assessment Code:</td><td>${code}</td></tr>
            <tr><td style="font-weight: bold;">Assessment Title:</td><td>${title}</td></tr>
          </table>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, Delete',
        cancelButtonText: 'Cancel',
        reverseButtons: true
      }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/lecturer/assessment/delete/' + code,
          type: 'DELETE',
          success: function (res) {
            Swal.fire('Deleted!', res.message, 'success').then(() => {
              location.reload();
            });
          },
          error: function (xhr) {
            Swal.fire('Error', xhr.responseJSON?.message || 'Failed to delete assessment.', 'error');
            
          }
        });
      }
      });
    });
  });
</script>

{% endblock %}
