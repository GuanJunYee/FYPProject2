{% extends 'base_lecdashboard.html' %}
{% block title %}Exam Timetable{% endblock %}
{% block breadcrumb %}Examinations > Exam Timetable{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/useredit.css') }}">

<div class="profile-header">
  <h2 style="margin-left: 20px;">Exam Timetable</h2>
</div>

<hr style="width: 100%;">

<form method="GET" action="{{ url_for('exam_timetable_create') }}">
  <button type="submit" class="btnCreate" style="margin-left: 90%;">Create</button>
</form>

<div id="studentList">
  <table class="studentList">
    <thead>
      <tr>
        <th>No.</th>
        <th>Assessment Code</th>
        <th>Assessment Title</th>
        <th>Exam Date</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Edit</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for timetable in exam_timetables %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ timetable.assessment_code }}</td>
        <td>
          {% for a in assessments %}
            {% if a.assessment_code == timetable.assessment_code %}
              {{ a.title }}
            {% endif %}
          {% endfor %}
        </td>
        <td>{{ timetable.exam_date }}</td>
        <td>{{ timetable.start_time }}</td>
        <td>{{ timetable.end_time }}</td>
        <td class="btnUpdate">
          <a href="{{ url_for('exam_timetable_edit', assessment_code=timetable.assessment_code) }}"><i class='fas fa-edit'></i></a>
        </td>
        <td class="btnDelete">
          <a href="#" class="delete-timetable-btn"
            data-code="{{ timetable.assessment_code }}"
            data-title="{% for a in assessments %}
            {% if a.assessment_code == timetable.assessment_code %}
              {{ a.title }}
            {% endif %}
          {% endfor %}"
            data-date="{{ timetable.exam_date }}"
            data-start="{{ timetable.start_time }}"
            data-end="{{ timetable.end_time }}">
            <i class="fas fa-trash"></i>
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" style="text-align:center;">No exam timetables available.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  $(document).on('click', '.delete-timetable-btn', function (e) {
    e.preventDefault();

    const code = $(this).data('code');
    const title = $(this).data('title');
    const date = $(this).data('date');
    const start = $(this).data('start');
    const end = $(this).data('end');

    Swal.fire({
      title: 'Delete Exam Timetable?',
      html: `
      <span style="color: #dc2626;">This action cannot be undone.</span>
        <table style="width:100%; font-size: 16px; text-align: left; padding-left: 80px; line-height: 1.8;">
            <tr><td style="font-weight: bold;">Assessment Code:</td><td>${code}</td></tr>
            <tr><td style="font-weight: bold;">Assessment Title:</td><td>${title}</td></tr>
            <tr><td style="font-weight: bold;">Date:</td><td>${date}</td></tr>
            <tr><td style="font-weight: bold;">Time:</td><td>${start} - ${end}</td></tr>
        </table>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, Delete',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/lecturer/exam/timetable/delete/' + code,
          type: 'DELETE',
          success: res => {
            Swal.fire('Deleted!', res.message, 'success').then(() => location.reload());
          },
          error: xhr => {
            Swal.fire('Error', xhr.responseJSON?.message || 'Delete failed', 'error');
          }
        });
      }
    });
  });
</script>
{% endblock %}
