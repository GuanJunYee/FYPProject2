{% extends "base.html" %}
{% block content %}

<div class="form-container">
  <h1>Online Examination System</h1>
  <p class="login-subtitle">We'll help you reset your password securely</p>

  <form>
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-bar-fill" id="progress-fill"></div>
        <div class="progress-step active" id="progress-step-1">
          <div class="step-circle">1</div>
          <div class="step-label">Email</div>
        </div>
        <div class="progress-step" id="progress-step-2">
          <div class="step-circle">2</div>
          <div class="step-label">Verify</div>
        </div>
        <div class="progress-step" id="progress-step-3">
          <div class="step-circle">3</div>
          <div class="step-label">Reset</div>
        </div>
      </div>
    </div>

    <!-- Step 1: Email Input -->
    <div class="form-step active" id="step-1">
      <div class="input-group">
        <i class="fas fa-envelope"></i>
        <input type="email" id="email" name="email" placeholder="Enter your registered email" required>
      </div>
      
      <div class="step-info">
        <i class="fas fa-info-circle"></i>
        <span>Enter the email address associated with your account</span>
      </div>
      
      <div class="step-buttons">
        <div></div>
        <button type="button" class="btn-next" id="requestOtpBtn" onclick="sendResetOTP()">
          <span class="button-text">Send Verification Code</span>
          <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
        </button>
      </div>
    </div>

    <!-- Step 2: OTP Verification -->
    <div class="form-step" id="step-2">
      <div class="email-display">
        <i class="fas fa-check-circle"></i>
        <p>We sent a 6-digit verification code to:</p>
        <strong id="emailDisplay"></strong>
      </div>
      
      <div class="otp-container">
        <input type="text" class="otp-input" maxlength="1" id="otp1" pattern="[0-9]">
        <input type="text" class="otp-input" maxlength="1" id="otp2" pattern="[0-9]">
        <input type="text" class="otp-input" maxlength="1" id="otp3" pattern="[0-9]">
        <input type="text" class="otp-input" maxlength="1" id="otp4" pattern="[0-9]">
        <input type="text" class="otp-input" maxlength="1" id="otp5" pattern="[0-9]">
        <input type="text" class="otp-input" maxlength="1" id="otp6" pattern="[0-9]">
      </div>
      
      <div class="countdown-info">
        <i class="fas fa-clock"></i>
        <span>Code expires in: <span id="countdown" class="countdown-timer">1:00</span></span>
      </div>

      <div class="step-buttons">
        <button type="button" class="btn-prev" onclick="goToStep(1)">
          Previous
        </button>
        <button type="button" class="btn-next" id="verifyOtpBtn">
          Verify Code
        </button>
      </div>
      
      <div class="resend-section">
          <p style="margin-top: 20px; text-align: center;">
            Didn't receive the code?
            <a href="javascript:void(0)" onclick="resendResetOTP()" class="resend-link" id="resendLink">
              Resend Code
            </a>  
          </p>
      </div>
    </div>

    <!-- Step 3: New Password -->
    <div class="form-step" id="step-3">
      <div class="password-requirements">
        <h4><i class="fas fa-shield-alt"></i> Password Requirements</h4>
        <ul>
          <li>At least 8 characters long</li>
          <li>Contains uppercase and lowercase letters</li>
          <li>Contains at least one number</li>
          <li>Contains at least one special character</li>
        </ul>
      </div>
      
      <div class="step3-timer-info" style="margin-bottom: 10px;">
          <i class="fas fa-clock"></i>
          <span>Please reset your password within: <span id="step3-countdown" class="countdown-timer">10:00</span></span>
      </div>

      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required>
        <i class="fas fa-eye-slash toggle-password" onclick="togglePassword('newPassword', this)" style="margin-left: 85%; margin-top: 3px;"></i>
      </div>
      
      <div class="input-group">
        <i class="fas fa-lock"></i>
        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required>
        <i class="fas fa-eye-slash toggle-password" onclick="togglePassword('confirmPassword', this)" style="margin-left: 85%; margin-top: 3px;"></i>
      </div>
      
      <div id="password-error" class="error-message"></div>
      <div id="password-strength" class="password-strength">
        <div class="strength-bar">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <span id="strengthText">Password strength: Weak</span>
      </div>

      <div class="step-buttons">
        <button type="button" class="btn-prev" onclick="goToStep(2)">
           Previous
        </button>
        <button type="button" class="btn-submit" id="resetPasswordBtn" onclick="resetPassword()">
           Reset Password
        </button>
      </div>
    </div>
  </form>
  <div class="back-to-login">
    <p>Remember your password? <a href="{{ url_for('login') }}">Back to Login</a></p>
  </div>
</div>

<script>
// Current step tracking
let currentStep = 1;

// OTP Input Management
const otpInputs = document.querySelectorAll('.otp-input');
otpInputs.forEach((input, index) => {
    input.addEventListener('input', function() {
        if (this.value.length === 1) {
            this.classList.add('filled');
            if (index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        } else {
            this.classList.remove('filled');
        }
        
        // Only allow numbers
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && this.value === '') {
            this.classList.remove('filled');
            if (index > 0) {
                otpInputs[index - 1].focus();
            }
        }
    });

    input.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        const numbers = paste.replace(/[^0-9]/g, '');
        
        for (let i = 0; i < Math.min(numbers.length, otpInputs.length - index); i++) {
            if (otpInputs[index + i]) {
                otpInputs[index + i].value = numbers[i];
                otpInputs[index + i].classList.add('filled');
            }
        }
    });
});

// Step Management Functions
function updateProgressBar(step) {
    const progressFill = document.getElementById('progress-fill');
    const progressSteps = document.querySelectorAll('.progress-step');
    
    // Update progress bar fill
    const percentage = ((step - 1) / 2) * 100;
    progressFill.style.width = percentage + '%';
    
    // Update step indicators
    progressSteps.forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
            stepEl.classList.add('completed');
        } else if (index + 1 === step) {
            stepEl.classList.add('active');
        }
    });
}

function goToStep(step) {
    try {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
        
        // Show target step
        const targetStep = document.getElementById(`step-${step}`);
        if (targetStep) {
            targetStep.classList.add('active');
        } else {
            console.error(`Step ${step} element not found`);
            return;
        }
        
        // Update progress
        updateProgressBar(step);
        currentStep = step;
        
        // Hide alerts when changing steps
        const successAlert = document.getElementById('successAlert');
        const errorAlert = document.getElementById('errorAlert');
        
        if (successAlert) {
            successAlert.style.display = 'none';
            successAlert.classList.remove('show');
        }
        if (errorAlert) {
            errorAlert.style.display = 'none';
            errorAlert.classList.remove('show');
        }
        
        // Focus management for different steps
        if (step === 2) {
            // Focus first OTP input when going to step 2
            setTimeout(() => {
                const firstOtpInput = document.getElementById('otp1');
                if (firstOtpInput) {
                    firstOtpInput.focus();
                }
            }, 100);
        } else if (step === 3) {
            // Focus first password input when going to step 3
            setTimeout(() => {
                const newPasswordInput = document.getElementById('newPassword');
                if (newPasswordInput) {
                    newPasswordInput.focus();
                }
            }, 100);
        }
    } catch (error) {
        console.error('Error in goToStep:', error);
    }
}

function showAlert(message, type = 'danger') {
    console.log('showAlert called with:', message, type);
    
    // Hide all alerts first
    const successAlert = document.getElementById('successAlert');
    const errorAlert = document.getElementById('errorAlert');
    
    if (successAlert) {
        successAlert.style.display = 'none';
        successAlert.classList.remove('show');
    }
    if (errorAlert) {
        errorAlert.style.display = 'none';
        errorAlert.classList.remove('show');
    }
    
    // Show the appropriate alert
    const alertElement = document.getElementById(type === 'danger' ? 'errorAlert' : 'successAlert');
    
    if (alertElement) {
        alertElement.textContent = message;
        alertElement.style.display = 'block';
        alertElement.classList.add('show');
        
        console.log('Alert displayed:', alertElement);
        
        setTimeout(() => {
            alertElement.style.display = 'none';
            alertElement.classList.remove('show');
        }, 5000);
    } else {
        // Fallback: create a temporary alert if elements don't exist
        console.warn('Alert element not found, creating temporary alert');
        const tempAlert = document.createElement('div');
        tempAlert.className = `flash ${type === 'danger' ? 'danger' : 'success'}`;
        tempAlert.style.display = 'block';
        tempAlert.style.margin = '10px 0';
        tempAlert.textContent = message;
        
        const container = document.querySelector('.form-container');
        if (container) {
            container.insertBefore(tempAlert, container.firstChild);
            setTimeout(() => {
                if (tempAlert.parentNode) {
                    tempAlert.parentNode.removeChild(tempAlert);
                }
            }, 5000);
        }
    }
}

// Password strength checker
function checkPasswordStrength(password) {
    const strengthFill = document.getElementById('strengthFill');
    const strengthText = document.getElementById('strengthText');
    
    let strength = 0;
    let text = 'Weak';
    let color = '#dc3545';
    
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    switch (strength) {
        case 0:
        case 1:
            text = 'Very Weak';
            color = '#dc3545';
            break;
        case 2:
            text = 'Weak';
            color = '#fd7e14';
            break;
        case 3:
            text = 'Fair';
            color = '#ffc107';
            break;
        case 4:
            text = 'Good';
            color = '#20c997';
            break;
        case 5:
            text = 'Strong';
            color = '#28a745';
            break;
    }
    
    strengthFill.style.width = (strength * 20) + '%';
    strengthFill.style.background = color;
    strengthText.textContent = `Password strength: ${text}`;
    strengthText.style.color = color;
}

// Add event listeners for password inputs
document.getElementById('newPassword').addEventListener('input', function() {
    checkPasswordStrength(this.value);
});

// Send Reset OTP
async function sendResetOTP() {
    console.log('sendResetOTP called');
    
    const email = document.getElementById('email').value;
    const btn = document.getElementById('requestOtpBtn');
    const spinner = document.getElementById('loadingSpinner');
    const buttonText = btn.querySelector('.button-text');
    
    if (!email) {
        showAlert('Please enter your email address');
        return;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('Please enter a valid email address');
        return;
    }
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    buttonText.textContent = 'Sending...';
    
    try {
        console.log('Making API request to /forgot-password-otp');
        
        const response = await fetch('/forgot-password-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });
        
        console.log('Response received:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            console.log('Success! Going to step 2');
            showAlert('Verification code sent to your email!', 'success');
            
            // Small delay to ensure alert is shown before step change
            setTimeout(() => {
                goToStep(2);
                // Set email display after going to step 2
                setTimeout(() => {
                    const emailDisplayElement = document.getElementById('emailDisplay');
                    if (emailDisplayElement) {
                        emailDisplayElement.textContent = email;
                        console.log('Email display set to:', email);
                    } else {
                        console.error('emailDisplay element not found');
                    }
                }, 200);
                startCountdown();
            }, 500);
            
        } else {
            console.log('API returned error:', data.error);
            showAlert(data.error || 'Failed to send verification code');
        }
    } catch (error) {
        console.log('Fetch error, running in demo mode:', error);
        // Demo mode - if API is not available, simulate the process
        setTimeout(() => {
            showAlert('Verification code sent to your email! (Demo Mode)', 'success');
            
            setTimeout(() => {
                goToStep(2);
                setTimeout(() => {
                    const emailDisplayElement = document.getElementById('emailDisplay');
                    if (emailDisplayElement) {
                        emailDisplayElement.textContent = email;
                        console.log('Email display set to (demo):', email);
                    } else {
                        console.error('emailDisplay element not found in demo mode');
                    }
                }, 200);
                startCountdown();
            }, 500);
            
        }, 1500);
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
        buttonText.textContent = 'Send Verification Code';
    }
}

// Verify Reset OTP
async function verifyResetOTP() {
    const otp = Array.from(otpInputs).map(input => input.value).join('');
    const email = document.getElementById('email').value;

    if (otp.length !== 6) {
        showAlert('Please enter the complete 6-digit code');
        return;
    }

    try {
        const response = await fetch('/verify-reset-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email, otp: otp })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Clear the countdown timer since OTP was verified successfully
            if (window.countdownTimer) {
                clearInterval(window.countdownTimer);
            }
            
            showAlert('Code verified successfully!', 'success');
            goToStep(3);
            
            // Start the step 3 countdown timer
            startStep3Countdown();
        } else {
            // Clear OTP inputs first
            otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            otpInputs[0].focus();
            
            // Show error message only once
            showAlert(data.error || 'Invalid verification code');
        }
    } catch (error) {
        console.error('Error verifying OTP:', error);
        
        // Clear OTP inputs
        otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('filled');
        });
        otpInputs[0].focus();
        
        // Show network error message
        showAlert('Network error. Please check your connection and try again.');
    }
}


// Reset Password
async function resetPassword() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const email = document.getElementById('email').value;
    const errorDiv = document.getElementById('password-error');
    
    // Clear previous errors
    errorDiv.textContent = '';
    
    if (!newPassword || !confirmPassword) {
        errorDiv.textContent = 'Please fill in both password fields';
        return;
    }
    
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        return;
    }
    
    // Password validation
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9])[A-Za-z\d\W]{8,}$/;
    if (!passwordRegex.test(newPassword)) {
        errorDiv.textContent = 'Password must be at least 8 characters with uppercase, lowercase, number, and special character.';
        return;
    }
    
    try {
        const response = await fetch('/reset-password-final', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                email: email, 
                newPassword: newPassword 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear the step 3 timer
            if (window.step3Timer) {
                clearInterval(window.step3Timer);
            }
            
            showAlert('Password reset successfully! Redirecting to login...', 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("login") }}';
            }, 1000);
        } else {
            showAlert(data.error || 'Failed to reset password');
        }
    } catch (error) {
        // Demo mode - simulate successful password reset
        console.log('API not available, running in demo mode');
        showAlert('Password reset successfully! (Demo Mode) Redirecting to login...', 'success');
        setTimeout(() => {
            // In demo mode, you can redirect to login or reload the page
            window.location.href = '{{ url_for("login") }}';
        }, 2000);
    }
}

// Resend OTP
function resendResetOTP() {
    // Clear OTP inputs
    otpInputs.forEach(input => {
        input.value = '';
        input.classList.remove('filled');
    });
    
    // Send new OTP
    sendResetOTP();
    
    // Start countdown again after sending
    setTimeout(() => {
        startCountdown();
    }, 100);
}

// Countdown timer
function startCountdown() {
    let timeLeft = 60; // 1 minute in seconds
    const countdownEl = document.getElementById('countdown');
    const resendLink = document.getElementById('resendLink');
    
    // Clear any existing timer first
    if (window.countdownTimer) {
        clearInterval(window.countdownTimer);
    }
    
    // Disable resend button during countdown
    if (resendLink) {
        resendLink.style.pointerEvents = 'none';
        resendLink.style.opacity = '0.5';
        resendLink.style.cursor = 'not-allowed';
    }
    
    // Store timer reference globally so we can clear it later
    window.countdownTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(window.countdownTimer);
            
            // Enable resend button
            if (resendLink) {
                resendLink.style.pointerEvents = 'auto';
                resendLink.style.opacity = '1';
                resendLink.style.cursor = 'pointer';
            }
            
            // Show expiry message
            showAlert('Verification code has expired. Click "Resend Code" to get a new one.');
            
            // Clear the OTP inputs
            otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            
            // Focus back to first input
            otpInputs[0].focus();
            
            // Stay on step 2 - don't go back to step 1
        }
        
        timeLeft--;
    }, 1000);
}

// Step 3 countdown timer (10 minutes)
function startStep3Countdown() {
    let timeLeft = 600; // 10 minutes in seconds
    const countdownEl = document.getElementById('step3-countdown');
    
    // Clear any existing step 3 timer
    if (window.step3Timer) {
        clearInterval(window.step3Timer);
    }
    
    // Store timer reference globally
    window.step3Timer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        if (countdownEl) {
            countdownEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        if (timeLeft <= 0) {
            clearInterval(window.step3Timer);
            
            // Show expiry message and redirect to step 1
            showAlert('Password reset session has expired. Please start over.');
            
            // Clear all form data
            document.getElementById('email').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Reset OTP inputs
            otpInputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled');
            });
            
            // Go back to step 1
            goToStep(1);
        }
        
        timeLeft--;
    }, 1000);
}

// Password toggle function
function togglePassword(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing forgot password form');
    updateProgressBar(1);
    
    // Add click event listener to verify button as backup
    const verifyBtn = document.getElementById('verifyOtpBtn');
    if (verifyBtn) {
        verifyBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Verify button clicked via event listener');
            verifyResetOTP();
        });
    }
    
    // Focus management observer
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.target.id === 'step-2' && mutation.target.classList.contains('active')) {
                console.log('Step 2 became active, focusing first OTP input');
                setTimeout(() => {
                    const firstOtpInput = document.getElementById('otp1');
                    if (firstOtpInput) {
                        firstOtpInput.focus();
                    }
                }, 100);
            }
        });
    });
    
    document.querySelectorAll('.form-step').forEach(step => {
        observer.observe(step, { attributes: true, attributeFilter: ['class'] });
    });
    
    console.log('Forgot password form initialized successfully');
});
</script>

{% endblock %}