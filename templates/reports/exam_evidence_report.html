{% extends 'base_lecdashboard.html' %}
{% block title %}Exam Evidence Report{% endblock %}
{% block breadcrumb %}Reports > Exam Evidence{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_registration_report.css') }}">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="profile-header">
    <h2 style="margin-left: 20px;">Exam Evidence Report</h2>
</div>

<hr style="width: 100%;">

<div class="report-container">
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="controls-grid">
            <div class="control-group">
                <label for="assessment-filter">Assessment Filter</label>
                <select id="assessment-filter" onchange="loadViolations()">
                    <option value="">All Assessments</option>
                    <!-- Options populated dynamically -->
                </select>
            </div>
            <div class="control-group">
                <label for="student-filter">Student Filter</label>
                <input type="text" id="student-filter" placeholder="Enter Student ID or Name" onchange="loadViolations()">
            </div>
            <div class="control-group">
                <label for="violation-type-filter">Violation Type</label>
                <select id="violation-type-filter" onchange="loadViolations()">
                    <option value="">All Types</option>
                    <option value="looking_away">Looking Away</option>
                    <option value="TAB_SWITCH">Tab Switch</option>
                    <option value="SCREEN_SHARE_STOPPED">Screen Share Stopped</option>
                    <option value="WEBCAM_DENIED">Webcam Denied</option>
                    <option value="FORBIDDEN_SHORTCUT">Forbidden Shortcut</option>
                </select>
            </div>
            <div class="control-group">
                <label for="status-filter">Review Status</label>
                <select id="status-filter" onchange="loadViolations()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="reviewed">Reviewed</option>
                    <option value="dismissed">Dismissed</option>
                </select>
            </div>
        </div>
        <div class="control-actions">
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
            <button class="btn btn-primary" onclick="loadViolations()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card total-users">
                <div class="stat-number" id="total-violations">0</div>
                <div class="stat-label">Total Violations</div>
                <div class="stat-change positive" id="total-change">Loading...</div>
            </div>
            <div class="stat-card students">
                <div class="stat-number" id="pending-reviews">0</div>
                <div class="stat-label">Pending Reviews</div>
                <div class="stat-change neutral" id="pending-change">Loading...</div>
            </div>
            <div class="stat-card lecturers">
                <div class="stat-number" id="with-evidence">0</div>
                <div class="stat-label">With Evidence</div>
                <div class="stat-change positive" id="evidence-change">Loading...</div>
            </div>
            <div class="stat-card growth-rate">
                <div class="stat-number" id="dismissed-rate">0%</div>
                <div class="stat-label">Dismissed Rate</div>
                <div class="stat-change negative" id="dismissed-change">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Evidence Gallery -->
    <div class="data-table-section">
        <div class="table-header">
            <div class="table-title">Evidence Review</div>
            <div class="table-actions">
                <button class="btn btn-success" onclick="exportReport()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
        </div>

        <div id="violations-container" class="violations-list">
            <div class="loading-state">
                <i class="fas fa-spinner fa-spin"></i> Loading violations...
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-section" id="pagination-section" style="display: none;">
            <div class="pagination-info">
                Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-count">0</span> violations
            </div>
            <div class="pagination-controls" id="pagination-controls">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Evidence Review Modal -->
<div class="evidence-modal-overlay" id="evidenceModalOverlay" style="display: none;">
    <div class="evidence-modal">
        <div class="evidence-modal-header">
            <div class="modal-header-content">
                <h3>Evidence Review</h3>
                <div class="violation-header-info">
                    <span id="modal-student-name">Student Name</span>
                    <span id="modal-timestamp" class="timestamp">Timestamp</span>
                </div>
            </div>
            <button class="modal-close-btn" onclick="closeEvidenceModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="evidence-modal-body">
            <div class="modal-content-grid">
                <!-- Left Column - Evidence Files -->
                <div class="evidence-section">
                    <h4>Evidence Files</h4>
                    <div class="evidence-files-container" id="modal-evidence-files">
                        <!-- Evidence files will be loaded here -->
                    </div>
                </div>
                
                <!-- Right Column - Violation Details & Review -->
                <div class="review-section">
                    <div class="violation-details-card">
                        <h4>Violation Details</h4>
                        <div id="modal-violation-details" class="violation-details-content">
                            <!-- Violation details will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="review-form-card">
                        <h4>Review & Decision</h4>
                        <div class="form-group">
                            <label for="modal-notes">Review Notes:</label>
                            <textarea id="modal-notes" rows="4" placeholder="Add your review notes here..."></textarea>
                        </div>
                        <div class="review-actions">
                            <button class="btn btn-success" onclick="reviewViolation('reviewed')">
                                <i class="fas fa-check"></i> Mark as Reviewed
                            </button>
                            <button class="btn btn-secondary" onclick="reviewViolation('dismissed')">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                            <button class="btn btn-warning" onclick="reviewViolation('pending')">
                                <i class="fas fa-undo"></i> Mark as Pending
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Evidence Report Styles */
.violations-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 30px;
}

.violation-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 2px solid transparent;
}

.violation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.violation-header {
    padding: 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.violation-info h6 {
    margin: 0 0 5px 0;
    color: #1e293b;
    font-weight: 700;
    font-size: 1.1rem;
}

.violation-info small {
    color: #64748b;
    font-size: 0.9rem;
}

.violation-body {
    padding: 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
}

.violation-content {
    flex: 1;
}

.violation-details {
    margin-bottom: 15px;
}

.violation-details strong {
    color: #1e293b;
    font-size: 1.1rem;
    display: block;
    margin-bottom: 8px;
}

.violation-details p {
    color: #64748b;
    margin: 0;
    line-height: 1.5;
}

.violation-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.meta-item {
    font-size: 0.9rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 5px;
}

.evidence-preview {
    margin-bottom: 0;
}

.evidence-thumbnails {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.evidence-thumbnail {
    width: 100px;
    height: 75px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid #e2e8f0;
    transition: border-color 0.3s;
}

.evidence-thumbnail:hover {
    border-color: #4f46e5;
}

.evidence-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.evidence-thumbnail.video {
    background: #f8fafc;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #64748b;
    font-size: 1.5rem;
}

.violation-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: 10px;
}

.status-pending {
    background: #fef3c7;
    color: #d97706;
}

.status-reviewed {
    background: #d1fae5;
    color: #059669;
}

.status-dismissed {
    background: #fee2e2;
    color: #dc2626;
}

/* FIXED MODAL STYLES - Appears at current scroll position */
.evidence-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: none;
    align-items: flex-start;
    justify-content: center;
    padding: 60px 20px;
    overflow-y: auto;
}


.evidence-modal {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.25);
    max-width: 1200px;
    width: 100%;
    max-height: 85vh; /* Changed from calc() to percentage */
    overflow: hidden;
    display: flex;
    flex-direction: column;
    position: relative;
    transform: scale(0.9); /* Start slightly smaller */
    transition: transform 0.3s ease; /* Smooth animation */
}

.evidence-modal.show {
    transform: scale(1); /* Full size when shown */
}

.evidence-modal-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 24px 30px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-radius: 16px 16px 0 0;
    flex-shrink: 0;
}

.modal-header-content h3 {
    margin: 0 0 8px 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.violation-header-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.violation-header-info span {
    font-size: 0.9rem;
    opacity: 0.9;
}

.timestamp {
    font-size: 0.8rem !important;
    opacity: 0.7 !important;
}

.modal-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: background 0.3s;
    margin-left: 20px;
    flex-shrink: 0;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.evidence-modal-body {
    padding: 30px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
}

.modal-content-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    height: 100%;
    min-height: 500px;
}

.evidence-section h4,
.violation-details-card h4,
.review-form-card h4 {
    margin: 0 0 20px 0;
    color: #1e293b;
    font-size: 1.2rem;
    font-weight: 600;
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 10px;
}

.evidence-files-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.evidence-file {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    background: #f8fafc;
}

.evidence-file h6 {
    margin: 0 0 12px 0;
    color: #4f46e5;
    font-size: 0.95rem;
    font-weight: 600;
}

.evidence-file img,
.evidence-file video {
    width: 100%;
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 10px;
}

.evidence-file small {
    color: #64748b;
    font-size: 0.8rem;
}

.violation-details-card,
.review-form-card {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    height: fit-content;
}

.violation-details-content {
    color: #374151;
    line-height: 1.6;
}

.violation-details-content strong {
    color: #1e293b;
    display: block;
    margin-bottom: 8px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
    font-size: 0.9rem;
}

.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    resize: vertical;
    transition: border-color 0.3s;
    font-family: inherit;
}

.form-group textarea:focus {
    outline: none;
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.review-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.review-actions .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.review-actions .btn-success {
    background: #10b981;
    color: white;
}

.review-actions .btn-success:hover {
    background: #059669;
    transform: translateY(-1px);
}

.review-actions .btn-secondary {
    background: #6b7280;
    color: white;
}

.review-actions .btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
}

.review-actions .btn-warning {
    background: #f59e0b;
    color: white;
}

.review-actions .btn-warning:hover {
    background: #d97706;
    transform: translateY(-1px);
}

.pagination-section {
    padding: 20px 30px;
    background: #f8fafc;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pagination-controls {
    display: flex;
    gap: 8px;
}

.pagination-controls button {
    padding: 8px 16px;
    border: 2px solid #e5e7eb;
    background: white;
    color: #374151;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.pagination-controls button:hover {
    background: #f8fafc;
    border-color: #4f46e5;
}

.pagination-controls button.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
}

.loading-state {
    text-align: center;
    padding: 80px 20px;
    color: #64748b;
    font-size: 1.1rem;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .modal-content-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .evidence-modal {
        max-width: 95vw;
        margin: 10px;
    }
}

@media (max-width: 768px) {
    .violation-body {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .violation-actions {
        justify-content: center;
    }
    
    .evidence-modal-body {
        padding: 20px;
    }
    
    .review-actions {
        gap: 8px;
    }
    
    .review-actions .btn {
        padding: 10px 16px;
        font-size: 0.9rem;
    }
    
    .evidence-modal {
        margin: 10px;
        max-height: calc(100vh - 20px);
    }
}
</style>

<script>
let currentViolations = [];
let currentPage = 1;
let totalPages = 1;
let currentViolationId = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadAssessmentOptions();
    loadViolations();
});

// Load assessment options for filter
async function loadAssessmentOptions() {
    try {
        const response = await fetch('/api/assessments/list-for-violations');
        const result = await response.json();
        
        if (result.success && result.assessments) {
            const select = document.getElementById('assessment-filter');
            result.assessments.forEach(assessment => {
                const option = document.createElement('option');
                option.value = assessment.assessment_code;
                option.textContent = `${assessment.assessment_code} - ${assessment.title}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading assessments:', error);
    }
}

// Load violations with current filters
async function loadViolations(page = 1) {
    const container = document.getElementById('violations-container');
    container.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading violations...</div>';
    
    try {
        // Get filter values
        const assessment = document.getElementById('assessment-filter').value;
        const student = document.getElementById('student-filter').value;
        const violationType = document.getElementById('violation-type-filter').value;
        const status = document.getElementById('status-filter').value;
        
        // Build API URL
        const params = new URLSearchParams({
            page: page,
            per_page: 20,
            assessment_code: assessment,
            student_id: student,
            violation_type: violationType,
            status: status
        });
        
        const response = await fetch(`/api/evidence/violations?${params}`);
        const result = await response.json();
        
        if (result.success) {
            currentViolations = result.violations;
            updateViolationsDisplay();
            updatePagination(result.pagination);
            updateStatistics();
        } else {
            container.innerHTML = `<div class="loading-state" style="color: #dc3545;">Error: ${result.error}</div>`;
        }
        
    } catch (error) {
        container.innerHTML = '<div class="loading-state" style="color: #dc3545;">Error loading violations. Please try again.</div>';
        console.error('Error loading violations:', error);
    }
}

// Update violations display
function updateViolationsDisplay() {
    const container = document.getElementById('violations-container');
    container.className = 'violations-list';
    
    if (currentViolations.length === 0) {
        container.innerHTML = '<div class="loading-state">No violations found with current filters.</div>';
        return;
    }
    
    container.innerHTML = currentViolations.map(violation => createViolationCard(violation)).join('');
}

// Create violation card HTML
function createViolationCard(violation) {
    const statusClass = `status-${violation.status}`;
    
    // Format evidence thumbnails
    let evidenceThumbnails = '';
    
    if (violation.evidence_files && violation.evidence_files.length > 0) {
        evidenceThumbnails = violation.evidence_files.map(file => {
            if (file.type === 'screenshot') {
                return `<div class="evidence-thumbnail" onclick="openEvidenceModal('${violation._id}')">
                    <img src="${file.url}" alt="Screenshot">
                </div>`;
            } else if (file.type === 'video') {
                return `<div class="evidence-thumbnail video" onclick="openEvidenceModal('${violation._id}')" title="Video Evidence">
                    <i class="fas fa-play"></i>
                </div>`;
            }
            return '';
        }).join('');
    } else {
        evidenceThumbnails = '<small class="text-muted">No evidence files available</small>';
    }
    
    return `
        <div class="violation-card" data-violation-id="${violation._id}">
            <div class="violation-header">
                <div class="violation-info">
                    <h6>${violation.student_name || 'Unknown Student'}</h6>
                    <small>${violation.assessment_code} - ${violation.assessment_title || 'Unknown Assessment'}</small>
                </div>
                <span class="status-badge ${statusClass}">${violation.status.replace('_', ' ').toUpperCase()}</span>
            </div>
            <div class="violation-body">
                <div class="violation-content">
                    <div class="violation-details">
                        <strong>${violation.violation_type.replace('_', ' ').toUpperCase()}</strong>
                        <p>${violation.description}</p>
                    </div>
                    <div class="violation-meta">
                        <div class="meta-item">
                            <i class="fas fa-clock"></i> ${new Date(violation.timestamp).toLocaleString()}
                        </div>
                        ${violation.exam_progress_percent ? 
                            `<div class="meta-item">
                                <i class="fas fa-chart-line"></i> ${violation.exam_progress_percent.toFixed(1)}% progress
                            </div>` : ''
                        }
                    </div>
                </div>
                <div class="evidence-preview">
                    <div class="evidence-thumbnails">
                        ${evidenceThumbnails}
                    </div>
                </div>
                <div class="violation-actions">
                    <button class="btn btn-primary" onclick="openEvidenceModal('${violation._id}')">
                        <i class="fas fa-eye"></i> Review
                    </button>
                </div>
            </div>
        </div>
    `;
}

async function openEvidenceModal(violationId) {
    const violation = currentViolations.find(v => v._id === violationId);
    if (!violation) return;

    currentViolationId = violationId;

    // Save current scroll position
    savedScrollY = window.scrollY;

    // Update modal header
    document.getElementById('modal-student-name').textContent = violation.student_name || 'Unknown Student';
    document.getElementById('modal-timestamp').textContent = new Date(violation.timestamp).toLocaleString();

    // Update violation details
    document.getElementById('modal-violation-details').innerHTML = `
        <strong>${violation.violation_type.replace('_', ' ').toUpperCase()}</strong>
        <p style="margin: 8px 0;">${violation.description}</p>
        <p style="margin: 8px 0;"><strong>Assessment:</strong> ${violation.assessment_code}</p>
        ${violation.exam_progress_percent ? 
            `<p style="margin: 8px 0;"><strong>Exam Progress:</strong> ${violation.exam_progress_percent.toFixed(1)}%</p>` : ''
        }
    `;

    // Load existing notes
    document.getElementById('modal-notes').value = violation.notes || '';

    // Load evidence files
    const evidenceContainer = document.getElementById('modal-evidence-files');
    if (violation.evidence_files && violation.evidence_files.length > 0) {
        evidenceContainer.innerHTML = violation.evidence_files.map(file => {
            if (file.type === 'screenshot') {
                return `<div class="evidence-file">
                    <h6>Screenshot Evidence</h6>
                    <img src="${file.url}" alt="Screenshot Evidence">
                    <small>File: ${file.filename}</small>
                </div>`;
            } else if (file.type === 'video') {
                return `<div class="evidence-file">
                    <h6>Video Evidence</h6>
                    <video controls preload="metadata">
                        <source src="${file.url}" type="video/webm">
                        <source src="${file.url}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <small>File: ${file.filename}</small>
                </div>`;
            }
            return `<div class="evidence-file">
                <p>Unknown file type: ${file.type}</p>
                <small>File: ${file.filename}</small>
            </div>`;
        }).join('');
    } else {
        evidenceContainer.innerHTML = '<p class="text-muted">No evidence files available for this violation.</p>';
    }

    // Show modal overlay and scroll modal into view
    const modalOverlay = document.getElementById('evidenceModalOverlay');
    const modal = modalOverlay.querySelector('.evidence-modal');

    modalOverlay.style.display = 'flex';

    // Scroll modal into view smoothly
    setTimeout(() => {
        modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        modal.classList.add('show');
    }, 50);
}


function closeEvidenceModal() {
    const modalOverlay = document.getElementById('evidenceModalOverlay');
    const modal = modalOverlay.querySelector('.evidence-modal');

    modal.classList.remove('show');

    // Delay to allow animation
    setTimeout(() => {
        modalOverlay.style.display = 'none';
        currentViolationId = null;

        //  scroll position
        window.scrollTo({ top: savedScrollY, behavior: 'smooth' });
    }, 300);
}


// Review violation - UPDATED STATUS OPTIONS
async function reviewViolation(status) {
    if (!currentViolationId) return;
    
    const notes = document.getElementById('modal-notes').value;
    
    try {
        const response = await fetch('/api/evidence/review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }, body: JSON.stringify({
               violation_id: currentViolationId,
               status: status,
               notes: notes
           })
       });
       
       const result = await response.json();
       
       if (result.success) {
           Swal.fire('Success', result.message, 'success');
           closeEvidenceModal();
           loadViolations(currentPage);
       } else {
           Swal.fire('Error', result.error, 'error');
       }
       
   } catch (error) {
       Swal.fire('Error', 'Failed to update violation status', 'error');
       console.error('Error reviewing violation:', error);
   }
}

// Export report
async function exportReport() {
   try {
       // Get current filter values
       const assessment = document.getElementById('assessment-filter').value;
       const student = document.getElementById('student-filter').value;
       const violationType = document.getElementById('violation-type-filter').value;
       const status = document.getElementById('status-filter').value;
       
       const params = new URLSearchParams({
           assessment_code: assessment,
           student_id: student,
           violation_type: violationType,
           status: status
       });
       
       const response = await fetch(`/api/evidence/export?${params}`);
       
       if (response.ok) {
           const blob = await response.blob();
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.style.display = 'none';
           a.href = url;
           a.download = `evidence_report_${new Date().toISOString().split('T')[0]}.csv`;
           document.body.appendChild(a);
           a.click();
           window.URL.revokeObjectURL(url);
           document.body.removeChild(a);
           
           Swal.fire('Success', 'Report exported successfully!', 'success');
       } else {
           Swal.fire('Error', 'Failed to export report', 'error');
       }
       
   } catch (error) {
       Swal.fire('Error', 'Failed to export report', 'error');
       console.error('Error exporting report:', error);
   }
}

// Update pagination
function updatePagination(pagination) {
   const paginationSection = document.getElementById('pagination-section');
   const paginationControls = document.getElementById('pagination-controls');
   
   if (pagination.pages <= 1) {
       paginationSection.style.display = 'none';
       return;
   }
   
   paginationSection.style.display = 'flex';
   
   // Update pagination info
   const start = (pagination.page - 1) * pagination.per_page + 1;
   const end = Math.min(pagination.page * pagination.per_page, pagination.total);
   
   document.getElementById('showing-start').textContent = start;
   document.getElementById('showing-end').textContent = end;
   document.getElementById('total-count').textContent = pagination.total;
   
   // Update pagination controls
   let paginationHTML = '';
   
   // Previous button
   if (pagination.page > 1) {
       paginationHTML += `<button onclick="loadViolations(${pagination.page - 1})">Previous</button>`;
   }
   
   // Page numbers
   for (let i = 1; i <= Math.min(pagination.pages, 10); i++) {
       if (i === pagination.page) {
           paginationHTML += `<button class="active">${i}</button>`;
       } else {
           paginationHTML += `<button onclick="loadViolations(${i})">${i}</button>`;
       }
   }
   
   // Next button
   if (pagination.page < pagination.pages) {
       paginationHTML += `<button onclick="loadViolations(${pagination.page + 1})">Next</button>`;
   }
   
   paginationControls.innerHTML = paginationHTML;
   currentPage = pagination.page;
   totalPages = pagination.pages;
}

// Update statistics - UPDATED FOR NEW STATUS OPTIONS
function updateStatistics() {
   const totalViolations = currentViolations.length;
   const pendingReviews = currentViolations.filter(v => v.status === 'pending').length;
   const withEvidence = currentViolations.filter(v => v.evidence_files && v.evidence_files.length > 0).length;
   const dismissedCount = currentViolations.filter(v => v.status === 'dismissed').length;
   const reviewed = currentViolations.filter(v => v.status !== 'pending').length;
   
   document.getElementById('total-violations').textContent = totalViolations;
   document.getElementById('pending-reviews').textContent = pendingReviews;
   document.getElementById('with-evidence').textContent = withEvidence;

   // Calculate dismissed rate instead of false positive rate
   const dismissedRate = reviewed > 0 ? Math.round((dismissedCount / reviewed) * 100) : 0;
   document.getElementById('dismissed-rate').textContent = dismissedRate + '%';
   
   // Update change indicators
   document.getElementById('total-change').textContent = `${totalViolations} total found`;
   document.getElementById('pending-change').textContent = pendingReviews > 0 ? 'Needs attention' : 'All reviewed';
   document.getElementById('evidence-change').textContent = `${withEvidence} have files`;
   document.getElementById('dismissed-change').textContent = dismissedRate <= 20 ? 'Normal rate' : 'High rate';
}

// Reset all filters
function resetFilters() {
   document.getElementById('assessment-filter').value = '';
   document.getElementById('student-filter').value = '';
   document.getElementById('violation-type-filter').value = '';
   document.getElementById('status-filter').value = '';
   currentPage = 1;
   loadViolations();
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
   const modalOverlay = document.getElementById('evidenceModalOverlay');
   if (event.target === modalOverlay) {
       closeEvidenceModal();
   }
});

// Close modal with escape key
document.addEventListener('keydown', function(event) {
   if (event.key === 'Escape') {
       closeEvidenceModal();
   }
});
</script>

{% endblock %}