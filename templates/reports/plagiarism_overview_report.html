{% extends 'base_lecdashboard.html' %}
{% block title %}Plagiarism & Similarity Overview Report{% endblock %}
{% block breadcrumb %}Reports > Plagiarism & Similarity Analytics{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_registration_report.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
    .badge{
        display: inline-block;
        font-size: 0.85em;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
    }
</style>
<div class="profile-header">
    <h2 style="margin-left: 20px;">Plagiarism & Similarity Analytics Report</h2>
</div>

<hr style="width: 100%;">

<div class="report-container">
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="controls-grid">
            <div class="control-group">
                <label for="student-filter">Student Filter</label>
                <select id="student-filter" onchange="updateReport()">
                    <option value="all">All Students</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="control-group">
                <label for="assessment-filter">Assessment Code</label>
                <select id="assessment-filter" onchange="updateReport()">
                    <option value="all">All Assessments</option>
                <!-- Options will be populated dynamically -->
               </select>
           </div>
           <div class="control-group">
               <label for="plagiarism-level">Plagiarism Level</label>
               <select id="plagiarism-level" onchange="updateReport()">
                   <option value="all">All Levels</option>
                   <option value="high">High (>20%)</option>
                   <option value="low">Low (â‰¤20%)</option>
               </select>
           </div>
           <div class="control-group">
               <label for="date-range">Date Range</label>
               <select id="date-range" onchange="handleDateRangeChange()">
                   <option value="all">All Time</option>
                   <option value="today">Today</option>
                   <option value="week">Last 7 Days</option>
                   <option value="month">Last 30 Days</option>
                   <option value="custom">Custom Range</option>
               </select>
           </div>
           <div class="control-group custom-date-inputs" id="custom-date-inputs" style="display: none;">
               <div class="date-input-group">
                   <label for="start-date">From Date</label>
                   <input type="date" id="start-date" onchange="validateDateRange()">
               </div>
               <div class="date-input-group">
                   <label for="end-date">To Date</label>
                   <input type="date" id="end-date" onchange="validateDateRange()">
               </div>
               <div id="date-validation-error" class="date-error" style="display: none;">
                   To Date cannot be earlier than From Date
               </div>
           </div>
       </div>
       <div class="control-actions">
           <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
           <button class="btn btn-primary" id="refresh-btn" onclick="updateReport()">
               <i class="fas fa-sync-alt"></i> Refresh Data
           </button>
       </div>
   </div>

   <!-- Alert Section for High Plagiarism -->
   <div class="alert-section" id="alert-section" style="display: none;">
       <div class="alert-card">
           <div class="alert-header">
               <i class="fas fa-exclamation-triangle alert-icon"></i>
               <span class="alert-title">High Plagiarism Detected</span>
           </div>
           <div class="alert-content" id="alert-content">
               <!-- Dynamic alert content -->
           </div>
       </div>
   </div>

   <!-- Statistics Section -->
   <div class="stats-section">
       <div class="stats-grid">
           <div class="stat-card total-submissions">
               <div class="stat-number" id="total-submissions">Loading...</div>
               <div class="stat-label">Total Submissions</div>
               <div class="stat-change neutral" id="submissions-change">Loading...</div>
           </div>
           <div class="stat-card high-plagiarism">
               <div class="stat-number" id="high-plagiarism">Loading...</div>
               <div class="stat-label">High Plagiarism (>20%)</div>
               <div class="stat-change negative" id="plagiarism-change">Loading...</div>
           </div>
           <div class="stat-card avg-plagiarism">
               <div class="stat-number" id="avg-plagiarism">Loading...</div>
               <div class="stat-label">Average Plagiarism %</div>
               <div class="stat-change neutral" id="avg-change">Loading...</div>
           </div>
           <div class="stat-card resubmissions">
               <div class="stat-number" id="resubmissions">Loading...</div>
               <div class="stat-label">Resubmission Requests</div>
               <div class="stat-change neutral" id="resub-change">Loading...</div>
           </div>
       </div>

       <!-- Charts Section -->
       <div class="charts-section">
           <div class="chart-container">
               <div class="chart-title">Plagiarism Score Distribution</div>
               <canvas id="plagiarismDistributionChart" class="chart-canvas"></canvas>
           </div>
           <div class="chart-container">
               <div class="chart-title">Submissions Timeline (Monthly)</div>
               <canvas id="submissionTimelineChart" class="chart-canvas"></canvas>
           </div>
       </div>

       <div class="charts-section">
           <div class="chart-container">
               <div class="chart-title">Plagiarism by Assessment</div>
               <canvas id="assessmentChart" class="chart-canvas"></canvas>
           </div>
           <div class="chart-container">
               <div class="chart-title">Similarity Score Distribution</div>
               <canvas id="similarityChart" class="chart-canvas"></canvas>
           </div>
       </div>

       <!-- Plagiarism Detection Table -->
       <div class="data-table-section">
           <div class="table-header">
               <div class="table-title">Plagiarism Detection Results (External API)</div>
               <div class="table-actions">
                   <button class="btn btn-success" onclick="exportTableData('plagiarism-table', 'plagiarism_results')">
                       <i class="fas fa-download"></i> Export CSV
                   </button>
                   <button class="btn btn-secondary" onclick="exportTablePDF('plagiarism-table', 'Plagiarism Detection Results')">
                       <i class="fas fa-file-pdf"></i> Export PDF
                   </button>
               </div>
           </div>
           <table id="plagiarism-table" class="data-table">
               <thead>
                   <tr>
                       <th>Student ID</th>
                       <th>Student Name</th>
                       <th>Assessment</th>
                       <th>Filename</th>
                       <th>Submitted Date</th>
                       <th>Total Plagiarism Score</th>
                       <th>Status</th>
                       <th>Actions</th>
                   </tr>
               </thead>
               <tbody id="plagiarism-table-body">
                   <tr>
                       <td colspan="8" style="text-align: center; padding: 40px;">Loading data...</td>
                   </tr>
               </tbody>
           </table>
       </div>

       <!-- Similarity Comparison Table -->
       <div class="data-table-section">
           <div class="table-header">
               <div class="table-title">Similarity Comparison Results (Internal)</div>
               <div class="table-actions">
                   <button class="btn btn-success" onclick="exportTableData('similarity-table', 'similarity_results')">
                       <i class="fas fa-download"></i> Export CSV
                   </button>
                   <button class="btn btn-secondary" onclick="exportTablePDF('similarity-table', 'Similarity Comparison Results')">
                       <i class="fas fa-file-pdf"></i> Export PDF
                   </button>
               </div>
           </div>
           <table id="similarity-table" class="data-table">
               <thead>
                   <tr>
                       <th>Student ID</th>
                       <th>Student Name</th>
                       <th>Assessment</th>
                       <th>Original File</th>
                       <th>Resubmitted File</th>
                       <th>Similarity Score</th>
                       <th>Similarity Level</th>
                       <th>Status</th>
                       <th>Actions</th>
                   </tr>
               </thead>
               <tbody id="similarity-table-body">
                   <tr>
                       <td colspan="9" style="text-align: center; padding: 40px;">Loading data...</td>
                   </tr>
               </tbody>
           </table>
       </div>
   </div>

   <!-- Export Section -->
   <div class="export-section">
       <div class="export-info">
           Last updated: <strong id="last-updated">Loading...</strong>
       </div>
   </div>
</div>

<!-- Report Modal -->
<div id="report-modal" class="modal" style="display: none;">
   <div class="modal-content">
       <div class="modal-header">
           <h3>Report Viewer</h3>
           <span class="close" onclick="closeReportModal()">&times;</span>
       </div>
       <div class="modal-body" id="report-modal-body">
           <!-- Report content will be loaded here -->
       </div>
   </div>
</div>

<style>
/* Plagiarism Report Specific Styles */
.alert-section {
   margin: 20px;
   margin-bottom: 30px;
}

.alert-card {
   background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
   border: 1px solid #ef4444;
   border-radius: 12px;
   padding: 20px;
   box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.alert-header {
   display: flex;
   align-items: center;
   margin-bottom: 15px;
}

.alert-icon {
   color: #dc2626;
   font-size: 1.5em;
   margin-right: 12px;
}

.alert-title {
   color: #b91c1c;
   font-size: 1.2em;
   font-weight: 600;
}

.alert-content {
   color: #7f1d1d;
   line-height: 1.6;
}

.alert-content ul {
   margin: 10px 0;
   padding-left: 20px;
}

/* Statistics Cards */
.stat-card.total-submissions {
   background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
   border-left: 4px solid #3b82f6;
}

.stat-card.total-submissions .stat-number { color: #1d4ed8; }
.stat-card.total-submissions .stat-label { color: #1e40af; }

.stat-card.high-plagiarism {
   background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
   border-left: 4px solid #ef4444;
}

.stat-card.high-plagiarism .stat-number { color: #dc2626; }
.stat-card.high-plagiarism .stat-label { color: #b91c1c; }

.stat-card.avg-plagiarism {
   background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
   border-left: 4px solid #f59e0b;
}

.stat-card.avg-plagiarism .stat-number { color: #d97706; }
.stat-card.avg-plagiarism .stat-label { color: #92400e; }

.stat-card.resubmissions {
   background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
   border-left: 4px solid #8b5cf6;
}

.stat-card.resubmissions .stat-number { color: #7c3aed; }
.stat-card.resubmissions .stat-label { color: #6b21a8; }

/* Updated Plagiarism Level Badges - Match Chart Colors */
.plagiarism-low {
    background: #dcfce7;  /* Light green background */
    color: #16a34a;       /* Green text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.plagiarism-medium {
    background: #fef3c7;  /* Light yellow background */
    color: #f59e0b;       /* Yellow text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.plagiarism-high {
    background: #fed7aa;  /* Light orange background */
    color: #ea580c;       /* Orange text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.plagiarism-very-high {
    background: #fecaca;  /* Light red background */
    color: #dc2626;       /* Red text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.similarity-identical {
    background: #fecaca;  /* Light red background */
    color: #dc2626;       /* Red text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.similarity-very-similar {
    background: #fed7aa;  /* Light orange background */
    color: #ea580c;       /* Orange text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.similarity-somewhat-similar {
    background: #fef3c7;  /* Light yellow background */
    color: #f59e0b;       /* Yellow text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}


/* Updated Similarity Level Badges - Match Chart Colors */
.similarity-different {
    background: #dcfce7;  /* Light green background */
    color: #16a34a;       /* Green text - matches chart */
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

/* Status Badges */
.status-pending {
   background: #fef3c7;
   color: #92400e;
   padding: 2px 8px;
   border-radius: 12px;
   font-size: 0.8em;
}

.status-approved {
   background: #f0fdf4;
   color: #166534;
   padding: 2px 8px;
   border-radius: 12px;
   font-size: 0.8em;
}

.status-rejected {
   background: #fee2e2;
   color: #dc2626;
   padding: 2px 8px;
   border-radius: 12px;
   font-size: 0.8em;
}

/* Custom date inputs */
.custom-date-inputs {
   display: grid;
   grid-template-columns: repeat(2, 1fr);
   gap: 20px;
   margin-top: 15px;
   padding: 15px;
   background: #f8fafc;
   border-radius: 8px;
   border: 1px solid #e5e7eb;
}

.date-input-group {
   display: flex;
   flex-direction: column;
   gap: 8px;
}

.date-input-group label {
   font-weight: 600;
   color: #374151;
   font-size: 14px;
   margin-bottom: 0;
}

.date-input-group input {
   padding: 10px 12px;
   margin-bottom: 15px;
   border: 1px solid #d1d5db;
   border-radius: 6px;
   font-size: 14px;
   height: 42px;
   box-sizing: border-box;
   background: white;
   transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.date-input-group input:focus {
   outline: none;
   border-color: #3b82f6;
   box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.date-input-group input:hover {
   border-color: #9ca3af;
}

.date-input-group input.error {
   border-color: #ef4444;
   box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.date-error {
   color: #dc2626;
   font-size: 12px;
   margin-top: 5px;
   grid-column: span 2;
   text-align: center;
   background: #fef2f2;
   padding: 8px 12px;
   border-radius: 4px;
   border: 1px solid #fecaca;
}

/* Modal Styles */
.modal {
   position: fixed;
   z-index: 1000;
   left: 0;
   top: 0;
   width: 100%;
   height: 100%;
   background-color: rgba(0,0,0,0.5);
}

.modal-content {
   background-color: white;
   margin: 5% auto;
   padding: 0;
   border-radius: 8px;
   width: 90%;
   max-width: 1000px;
   max-height: 80vh;
   overflow: hidden;
}

.modal-header {
   background: #3b82f6;
   color: white;
   padding: 15px 20px;
   display: flex;
   justify-content: space-between;
   align-items: center;
}

.modal-header h3 {
   margin: 0;
}

.close {
   color: white;
   font-size: 28px;
   font-weight: bold;
   cursor: pointer;
}

.close:hover {
   opacity: 0.7;
}

.modal-body {
   padding: 20px;
   max-height: 60vh;
   overflow-y: auto;
}

/* Responsive adjustments */
@media (max-width: 768px) {
   .controls-grid {
       grid-template-columns: 1fr;
   }
   
   .charts-section {
       grid-template-columns: 1fr;
   }
   
   .custom-date-inputs {
       grid-template-columns: 1fr;
       gap: 15px;
   }
}

@media (max-width: 480px) {
   .custom-date-inputs {
       padding: 10px;
   }
   
   .date-input-group input {
       height: 40px;
       padding: 8px 10px;
   }
}
</style>

<script>
let plagiarismDistributionChart, submissionTimelineChart, assessmentChart, similarityChart;
let currentReportData = null;

// Initialize charts with updated colors (Orange for High, Red for Very High)
function initCharts() {
   // Plagiarism Distribution Chart - Pie chart with corrected colors
   const plagiarismCtx = document.getElementById('plagiarismDistributionChart').getContext('2d');
   plagiarismDistributionChart = new Chart(plagiarismCtx, {
       type: 'pie',
       data: {
           labels: ['Low (0-20%)', 'Medium (21-50%)', 'High (51-80%)', 'Very High (81-100%)'],
           datasets: [{
               data: [0, 0, 0, 0],
               backgroundColor: [
                   '#16a34a',  // Green for Low
                   '#f59e0b',  // Yellow for Medium  
                   '#ea580c',  // Orange for High
                   '#dc2626'   // Red for Very High
               ],
               borderWidth: 3,
               borderColor: '#ffffff'
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: {
                   position: 'bottom',
               },
               tooltip: {
                   callbacks: {
                       label: function(context) {
                           const label = context.label || '';
                           const value = context.parsed;
                           const total = context.dataset.data.reduce((a, b) => a + b, 0);
                           const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                           return `${label}: ${value} submissions (${percentage}%)`;
                       }
                   }
               }
           }
       }
   });

   // Submission Timeline Chart - Line chart
   const timelineCtx = document.getElementById('submissionTimelineChart').getContext('2d');
   submissionTimelineChart = new Chart(timelineCtx, {
       type: 'line',
       data: {
           labels: [],
           datasets: [{
               label: 'Submissions per Month',
               data: [],
               borderColor: '#3b82f6',
               backgroundColor: 'rgba(59, 130, 246, 0.1)',
               tension: 0.4,
               fill: true
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: {
                   position: 'top',
               }
           },
           scales: {
               y: {
                   beginAtZero: true,
                   title: {
                       display: true,
                       text: 'Number of Submissions'
                   }
               },
               x: {
                   title: {
                       display: true,
                       text: 'Month'
                   }
               }
           }
       }
   });

   // Assessment Chart - Bar chart with dynamic colors
   const assessmentCtx = document.getElementById('assessmentChart').getContext('2d');
   assessmentChart = new Chart(assessmentCtx, {
       type: 'bar',
       data: {
           labels: [],
           datasets: [{
               label: 'Average Plagiarism % by Assessment',
               data: [],
               backgroundColor: [],  // Will be set dynamically
               borderRadius: 6,
               borderSkipped: false,
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: {
                   position: 'top',
               }
           },
           scales: {
               y: {
                   beginAtZero: true,
                   max: 100,
                   title: {
                       display: true,
                       text: 'Average Plagiarism %'
                   }
               },
               x: {
                   title: {
                       display: true,
                       text: 'Assessment Code'
                   }
               }
           }
       }
   });

   // Similarity Chart - Doughnut chart with corrected colors
   const similarityCtx = document.getElementById('similarityChart').getContext('2d');
   similarityChart = new Chart(similarityCtx, {
       type: 'doughnut',
       data: {
           labels: ['Very Different (0-30%)', 'Somewhat Similar (31-60%)', 'Very Similar (61-80%)', 'Nearly Identical (81-100%)'],
           datasets: [{
               data: [0, 0, 0, 0],
               backgroundColor: [
                   '#16a34a',  // Green for Very Different
                   '#f59e0b',  // Yellow for Somewhat Similar
                   '#ea580c',  // Orange for Very Similar
                   '#dc2626'   // Red for Nearly Identical
               ],
               borderWidth: 3,
               borderColor: '#ffffff'
           }]
       },
       options: {
           responsive: true,
           maintainAspectRatio: false,
           plugins: {
               legend: {
                   position: 'bottom',
               },
               tooltip: {
                   callbacks: {
                       label: function(context) {
                           const label = context.label || '';
                           const value = context.parsed;
                           const total = context.dataset.data.reduce((a, b) => a + b, 0);
                           const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                           return `${label}: ${value} comparisons (${percentage}%)`;
                       }
                   }
               }
           }
       }
   });
}

// Handle date range changes and validation
function handleDateRangeChange() {
   const dateRange = document.getElementById('date-range').value;
   const customInputs = document.getElementById('custom-date-inputs');
   const dateError = document.getElementById('date-validation-error');
   
   if (dateRange === 'custom') {
       customInputs.style.display = 'block';
       // Set default dates for better UX
       const today = new Date();
       const weekAgo = new Date();
       weekAgo.setDate(today.getDate() - 7);
       
       document.getElementById('start-date').value = weekAgo.toISOString().split('T')[0];
       document.getElementById('end-date').value = today.toISOString().split('T')[0];
   } else {
       customInputs.style.display = 'none';
       dateError.style.display = 'none';
       // Clear validation errors
       document.getElementById('start-date').classList.remove('error');
       document.getElementById('end-date').classList.remove('error');
       updateReport(); // Auto-update for preset ranges
   }
}

// Validate custom date range
function validateDateRange() {
   const startDate = document.getElementById('start-date').value;
   const endDate = document.getElementById('end-date').value;
   const dateError = document.getElementById('date-validation-error');
   const startInput = document.getElementById('start-date');
   const endInput = document.getElementById('end-date');
   
   if (startDate && endDate) {
       const start = new Date(startDate);
       const end = new Date(endDate);
       
       if (end < start) {
           // Show error
           dateError.style.display = 'block';
           startInput.classList.add('error');
           endInput.classList.add('error');
           return false;
       } else {
           // Clear error and update report
           dateError.style.display = 'none';
           startInput.classList.remove('error');
           endInput.classList.remove('error');
           updateReport();
           return true;
       }
   }
   return true;
}

// Update report based on filters
async function updateReport() {
   const studentFilter = document.getElementById('student-filter').value;
   const assessmentFilter = document.getElementById('assessment-filter').value;
   const plagiarismLevelFilter = document.getElementById('plagiarism-level').value;
   const dateRangeFilter = document.getElementById('date-range').value;
   const startDate = document.getElementById('start-date').value;
   const endDate = document.getElementById('end-date').value;
   
   // Validate custom date range if selected
   if (dateRangeFilter === 'custom') {
       if (!validateDateRange()) {
           return; // Don't update if validation fails
       }
   }
   
   // Show loading state
   showLoadingState();

   try {
       // Build API URL with correct parameter names to match backend
       let apiUrl = `/api/reports/plagiarism-overview?student_id=${studentFilter}&assessment_code=${assessmentFilter}&plagiarism_level=${plagiarismLevelFilter}`;
       
       // Handle different date range options
       if (dateRangeFilter === 'custom' && startDate && endDate) {
           apiUrl += `&date_from=${startDate}&date_to=${endDate}`;
       } else if (['today', 'week', 'month'].includes(dateRangeFilter)) {
           apiUrl += `&date_from=${dateRangeFilter}`;
       }

       console.log('API URL:', apiUrl);

       // Fetch data from backend
       const response = await fetch(apiUrl);
       const result = await response.json();

       console.log('API Response:', result);

       if (result.success) {
           // Update charts with real data
           updateChartsWithData(result);
           
           // Update summary statistics
           updateSummaryStats(result.summary_stats);
           
           // Update data tables
           updatePlagiarismTable(result.plagiarism_table);
           updateSimilarityTable(result.similarity_table);
           
           // Update alerts
           updateAlerts(result.alerts);
           
           // Update last updated time
           document.getElementById('last-updated').textContent = new Date().toLocaleString();
           
           // Store data for export functions
           currentReportData = result;
           
       } else {
           console.error('API Error:', result.error);
           alert('Error loading report data: ' + result.error);
       }

   } catch (error) {
       console.error('Network Error:', error);
       alert('Error connecting to server. Please try again.');
   } finally {
       hideLoadingState();
   }
}

// Show loading state
function showLoadingState() {
   const refreshBtn = document.getElementById('refresh-btn');
   refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
   refreshBtn.disabled = true;
}

// Hide loading state
function hideLoadingState() {
   const refreshBtn = document.getElementById('refresh-btn');
   refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
   refreshBtn.disabled = false;
}

// Update charts with real data from API and dynamic bar colors
function updateChartsWithData(data) {
   console.log('Updating charts with data:', data);
   
   // Safety check
   if (!data || !data.chart_data) {
       console.error('Chart data is missing:', data);
       return;
   }
   
   const chartData = data.chart_data;
   
   // Update plagiarism distribution chart
   if (chartData.plagiarism_distribution) {
       plagiarismDistributionChart.data.datasets[0].data = [
           chartData.plagiarism_distribution['Low (0-20%)'] || 0,
           chartData.plagiarism_distribution['Medium (21-50%)'] || 0,
           chartData.plagiarism_distribution['High (51-80%)'] || 0,
           chartData.plagiarism_distribution['Very High (81-100%)'] || 0
       ];
       plagiarismDistributionChart.update();
   }

   // Update timeline chart
   if (chartData.timeline) {
       submissionTimelineChart.data.labels = chartData.timeline.labels || [];
       submissionTimelineChart.data.datasets[0].data = chartData.timeline.data || [];
       submissionTimelineChart.update();
   }

   // Update assessment chart with dynamic colors based on values
   if (chartData.assessment_plagiarism) {
       const assessmentLabels = chartData.assessment_plagiarism.labels || [];
       const assessmentData = chartData.assessment_plagiarism.data || [];
       
       // Create dynamic colors based on plagiarism percentage
       const assessmentColors = assessmentData.map(value => {
           if (value <= 20) return '#16a34a';      // Green for low (0-20%)
           else if (value <= 50) return '#f59e0b'; // Yellow for medium (21-50%)
           else if (value <= 80) return '#ea580c'; // Orange for high (51-80%)
           else return '#dc2626';                  // Red for very high (>80%)
       });
       
       assessmentChart.data.labels = assessmentLabels;
       assessmentChart.data.datasets[0].data = assessmentData;
       assessmentChart.data.datasets[0].backgroundColor = assessmentColors;
       assessmentChart.update();
   }

   // Update similarity chart
   if (chartData.similarity_distribution) {
       similarityChart.data.datasets[0].data = [
           chartData.similarity_distribution['Very Different (0-30%)'] || 0,
           chartData.similarity_distribution['Somewhat Similar (31-60%)'] || 0,
           chartData.similarity_distribution['Very Similar (61-80%)'] || 0,
           chartData.similarity_distribution['Nearly Identical (81-100%)'] || 0
       ];
       similarityChart.update();
   }
}

// Update summary statistics cards - no rounding
function updateSummaryStats(summary) {
   if (!summary) return;
   
   document.getElementById('total-submissions').textContent = summary.total_submissions || 0;
   document.getElementById('high-plagiarism').textContent = summary.high_plagiarism_count || 0;
   document.getElementById('avg-plagiarism').textContent = Math.round(summary.avg_plagiarism_score || 0) + '%'; 
   document.getElementById('resubmissions').textContent = summary.total_resubmissions || 0;

   // Update change indicators
   document.getElementById('submissions-change').textContent = summary.total_submissions + ' submissions';
   document.getElementById('plagiarism-change').textContent = summary.high_plagiarism_count > 0 ? 'Requires attention' : 'All good';
   document.getElementById('avg-change').textContent = summary.avg_plagiarism_score > 20 ? 'Above threshold' : 'Within limits';
   document.getElementById('resub-change').textContent = summary.total_resubmissions + ' requests';
}

// Update plagiarism table with chart-matching colors
function updatePlagiarismTable(plagiarismData) {
    const tbody = document.getElementById('plagiarism-table-body');
    tbody.innerHTML = '';

    if (!plagiarismData || plagiarismData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No plagiarism data available</td></tr>';
        return;
    }

    plagiarismData.forEach(submission => {
        const row = document.createElement('tr');
        
        // Get combined scores
        const totalPlagiarismScore = submission.total_plagiarism_score || 0;
        const basePlagiarismScore = submission.base_plagiarism_score || 0;
        const quotesScore = submission.quotes_score || 0;
        
        // Determine plagiarism level and class - MATCH CHART COLORS
        let plagiarismClass = 'plagiarism-low';      // Green (0-20%)
        let status = 'Original';
        
        if (totalPlagiarismScore > 80) {
            plagiarismClass = 'badge plagiarism-very-high';  // Red (81-100%)
            status = 'Very High Risk';
        } else if (totalPlagiarismScore > 50) {
            plagiarismClass = 'badge plagiarism-high';       // Orange (51-80%)
            status = 'High Risk';
        } else if (totalPlagiarismScore > 20) {
            plagiarismClass = 'badge plagiarism-medium';     // Yellow (21-50%)
            status = 'Review Required';
        }
        
        // Determine navigation URL
        const hasReport = submission.has_report;
        const submissionId = submission.id;
        const assessmentCode = submission.assessment_code;
        
        let viewUrl;
        if (hasReport) {
            viewUrl = `/lecturer/plagiarism/report/${submissionId}`;
        } else {
            viewUrl = `/lecturer/exam/submissions/${assessmentCode}`;
        }
        
        row.innerHTML = `
            <td><strong>${submission.student_id}</strong></td>
            <td>${submission.student_name}</td>
            <td>${submission.assessment_code}</td>
            <td title="${submission.filename}">${submission.filename.length > 15 ? submission.filename.substring(0, 15) + '...' : submission.filename}</td>
            <td>${submission.submitted_at}</td>
            <td>
                <span class="${plagiarismClass}" title="Base: ${basePlagiarismScore}% + Quotes: ${quotesScore}% = Total: ${totalPlagiarismScore}%">
                    ${totalPlagiarismScore}%
                </span>
            </td>
            <td><span class="${plagiarismClass}">${status}</span></td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="navigateToPlagiarismView('${viewUrl}')">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Update similarity table with chart-matching colors
function updateSimilarityTable(similarityData) {
    const tbody = document.getElementById('similarity-table-body');
    tbody.innerHTML = '';

    if (!similarityData || similarityData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No similarity data available</td></tr>';
        return;
    }

    similarityData.forEach(comparison => {
        const row = document.createElement('tr');
        
        // Determine similarity level and class - MATCH CHART COLORS
        const similarityScore = comparison.similarity_score || 0;
        let similarityClass = ' badge similarity-different';    // Green (0-30%)
        let similarityLevel = 'Very Different';
        
        if (similarityScore >= 81) {
            similarityClass = 'badge similarity-identical';        // Red (81-100%)
            similarityLevel = 'Nearly Identical';
        } else if (similarityScore >= 61) {
            similarityClass = 'badge similarity-very-similar';     // Orange (61-80%)
            similarityLevel = 'Very Similar';
        } else if (similarityScore >= 31) {
            similarityClass = 'badge similarity-somewhat-similar'; // Yellow (31-60%)
            similarityLevel = 'Somewhat Similar';
        }
        
        // Format status
        const status = comparison.status || 'Pending';
        const statusClass = `status-${status.toLowerCase()}`;
        
        // Determine navigation URL
        const hasSimilarityReport = comparison.has_similarity_report;
        const submissionId = comparison.submission_id;
        
        let viewUrl;
        if (hasSimilarityReport) {
            viewUrl = `/lecturer/exam/resubmission/${submissionId}/similarity`;
        } else {
            viewUrl = `/lecturer/exam/resubmission/${submissionId}`;
        }
        
        row.innerHTML = `
            <td><strong>${comparison.student_id}</strong></td>
            <td>${comparison.student_name}</td>
            <td>${comparison.assessment_code}</td>
            <td title="${comparison.old_filename}">${comparison.old_filename.length > 10 ? comparison.old_filename.substring(0, 10) + '...' : comparison.old_filename}</td>
            <td title="${comparison.new_filename}">${comparison.new_filename.length > 10 ? comparison.new_filename.substring(0, 10) + '...' : comparison.new_filename}</td>
            <td><span class="${similarityClass}">${similarityScore}%</span></td>
            <td><span class="${similarityClass}">${similarityLevel}</span></td>
            <td><span class="${statusClass}">${status}</span></td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="navigateToSimilarityView('${viewUrl}')">
                    <i class="fas fa-eye"></i> View
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Update alerts section
function updateAlerts(alerts) {
   const alertSection = document.getElementById('alert-section');
   const alertContent = document.getElementById('alert-content');
   
   if (!alerts || alerts.length === 0) {
       alertSection.style.display = 'none';
       return;
   }
   
   let alertHtml = '';
   alerts.forEach(alert => {
       alertHtml += `<p><strong>${alert.message}</strong></p>`;
   });
   
   alertContent.innerHTML = alertHtml;
   alertSection.style.display = 'block';
}

// Navigation functions with proper URL handling
function navigateToPlagiarismView(url) {
   console.log('Navigating to plagiarism view:', url);
   window.location.href = url;
}

function navigateToSimilarityView(url) {
   console.log('Navigating to similarity view:', url);
   window.location.href = url;
}

// Close report modal
function closeReportModal() {
   document.getElementById('report-modal').style.display = 'none';
}

// Reset all filters
function resetFilters() {
   document.getElementById('student-filter').value = 'all';
   document.getElementById('assessment-filter').value = 'all';
   document.getElementById('plagiarism-level').value = 'all';
   document.getElementById('date-range').value = 'all';
   document.getElementById('custom-date-inputs').style.display = 'none';
   document.getElementById('date-validation-error').style.display = 'none';
   document.getElementById('start-date').value = '';
   document.getElementById('end-date').value = '';
   document.getElementById('start-date').classList.remove('error');
   document.getElementById('end-date').classList.remove('error');
   updateReport();
}

// Export table data as CSV
function exportTableData(tableId, filename) {
   if (!currentReportData) {
       alert('No data available to export. Please wait for the report to load completely, then try again.');
       return;
   }

   const table = document.getElementById(tableId);
   const rows = Array.from(table.querySelectorAll('tr'));
   
   let csv = '';
   rows.forEach(row => {
       const cols = Array.from(row.querySelectorAll('th, td'));
       const csvRow = cols.map(col => {
           // Clean text content and handle special characters
           let text = col.textContent.trim().replace(/"/g, '""');
           return `"${text}"`;
       }).join(',');
       csv += csvRow + '\n';
   });
   
   // Create and download CSV file
   const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
   const url = window.URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
   document.body.appendChild(a);
   a.click();
   document.body.removeChild(a);
   window.URL.revokeObjectURL(url);

   Swal.fire('Success', 'Report exported successfully as CSV!', 'success');
}

// Export table as PDF
function exportTablePDF(tableId, title) {
   if (!currentReportData) {
       alert('No data available to export. Please wait for the report to load completely, then try again.');
       return;
   }

   try {
       // Create print-friendly version in new tab
       const printWindow = window.open('', '_blank');
       
       if (!printWindow) {
           alert('Unable to open print window. Please check your popup blocker.');
           return;
       }

       const htmlContent = `
<!DOCTYPE html>
<html>
<head>
   <title>${title}</title>
   <style>
       body { font-family: Arial, sans-serif; margin: 20px; }
       .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
       .header h1 { color: #333; margin: 0; }
       table { width: 100%; border-collapse: collapse; margin: 20px 0; }
       th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
       th { background: #3b82f6; color: white; font-weight: bold; }
       tr:nth-child(even) { background: #f9f9f9; }
       .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
       .plagiarism-high { color: #dc2626; font-weight: bold; }
       .plagiarism-medium { color: #ea580c; font-weight: bold; }
       .plagiarism-low { color: #16a34a; }
       .similarity-identical { color: #1f2937; font-weight: bold; }
       .similarity-very-similar { color: #dc2626; font-weight: bold; }
       .similarity-somewhat-similar { color: #d97706; font-weight: bold; }
       .similarity-different { color: #16a34a; }
   </style>
</head>
<body>
   <div class="header">
       <h1>Plagiarism & Similarity Analytics Report</h1>
       <p><strong>${title}</strong></p>
       <p>Generated: ${new Date().toLocaleString()}</p>
   </div>
   
   ${generatePDFTableContent(tableId)}
   
   <div class="footer">
       <p>Generated by Online Exam Platform - Plagiarism & Similarity Analytics</p>
       <p>Total Submissions: ${currentReportData.summary_stats.total_submissions} | High Plagiarism: ${currentReportData.summary_stats.high_plagiarism_count} | Avg Score: ${currentReportData.summary_stats.avg_plagiarism_score}%</p>
   </div>
</body>
</html>`;

       printWindow.document.write(htmlContent);
       printWindow.document.close();
       
       // Wait for content to load then print
       setTimeout(() => {
           printWindow.print();
       }, 1000);

       Swal.fire('Success', 'Report exported successfully as PDF!', 'success');
       
   } catch (error) {
       console.error('PDF Export Error:', error);
       alert('Failed to generate PDF: ' + error.message);
   }
}

// Generate PDF table content
function generatePDFTableContent(tableId) {
   const table = document.getElementById(tableId);
   if (!table) return '<p>Table not found.</p>';
   
   const rows = Array.from(table.querySelectorAll('tr'));
   let tableHTML = '<table>';
   
   rows.forEach(row => {
       const isHeader = row.closest('thead');
       const cellTag = isHeader ? 'th' : 'td';
       const cells = Array.from(row.querySelectorAll('th, td'));
       
       tableHTML += '<tr>';
       cells.forEach((cell, index) => {
           // Skip action columns in PDF (usually the last column)
           if (!cell.textContent.includes('Actions') && !cell.innerHTML.includes('btn')) {
               const cellContent = cell.textContent.trim();
               const cellClass = cell.querySelector('span') ? cell.querySelector('span').className : '';
               tableHTML += `<${cellTag} class="${cellClass}">${cellContent}</${cellTag}>`;
           }
       });
       tableHTML += '</tr>';
   });
   
   tableHTML += '</table>';
   return tableHTML;
}

// Load filter options
async function loadFilterOptions() {
   try {
       // Load students
       const studentsResponse = await fetch('/api/students/list');
       if (studentsResponse.ok) {
           const studentsResult = await studentsResponse.json();
           
           if (studentsResult.success) {
               const studentSelect = document.getElementById('student-filter');
               const allOption = studentSelect.querySelector('option[value="all"]');
               studentSelect.innerHTML = '';
               studentSelect.appendChild(allOption);
               
               studentsResult.students.forEach(student => {
                   const option = document.createElement('option');
                   option.value = student.student_id;
                   option.textContent = `${student.student_id} - ${student.name}`;
                   studentSelect.appendChild(option);
               });
           }
       }
       
       // Load assessments
       const assessmentsResponse = await fetch('/api/assessments/list');
       if (assessmentsResponse.ok) {
           const assessmentsResult = await assessmentsResponse.json();
           
           if (assessmentsResult.success) {
               const assessmentSelect = document.getElementById('assessment-filter');
               const allOption = assessmentSelect.querySelector('option[value="all"]');
               assessmentSelect.innerHTML = '';
               assessmentSelect.appendChild(allOption);
               
               assessmentsResult.assessments.forEach(assessment => {
                   const option = document.createElement('option');
                   option.value = assessment.assessment_code;
                   option.textContent = assessment.assessment_code;
                   assessmentSelect.appendChild(option);
               });
           }
       }
       
   } catch (error) {
       console.error('Error loading filter options:', error);
   }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
   initCharts();
   loadFilterOptions();
   updateReport();
   
   // Set up date range change handler
   document.getElementById('date-range').addEventListener('change', handleDateRangeChange);
});

// Close modal when clicking outside
window.onclick = function(event) {
   const modal = document.getElementById('report-modal');
   if (event.target == modal) {
       modal.style.display = 'none';
   }
}

// Additional utility functions
function formatDate(dateString) {
   if (!dateString) return 'N/A';
   try {
       const date = new Date(dateString);
       return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
   } catch (error) {
       return dateString;
   }
}

function truncateFilename(filename, maxLength = 15) {
   if (!filename) return 'N/A';
   return filename.length > maxLength ? filename.substring(0, maxLength) + '...' : filename;
}

// Debug function to help with troubleshooting
function debugReportData() {
   if (currentReportData) {
       console.log('Current Report Data:', currentReportData);
       return currentReportData;
   } else {
       console.log('No report data available');
       return null;
   }
}
</script>

{% endblock %}