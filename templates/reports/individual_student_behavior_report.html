{% extends 'base_lecdashboard.html' %}
{% block title %}Individual Student Behavior Report{% endblock %}
{% block breadcrumb %}Reports > Student Behavior Analytics{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_registration_report.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<div class="profile-header">
    <h2 style="margin-left: 20px;">Individual Student Behavior Analytics Report</h2>
</div>

<hr style="width: 100%;">

<div class="report-container">
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="controls-grid">
            <div class="control-group">
                <label for="student-filter">Student Filter</label>
                <select id="student-filter" onchange="updateReport()">
                    <option value="all">All Students</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="control-group">
                <label for="violation-type">Violation Type</label>
                <select id="violation-type" onchange="updateReport()">
                    <option value="all">All Types</option>
                    <option value="looking_away">Looking Away</option>
                    <option value="TAB_SWITCH">Tab Switch</option>
                    <option value="FORBIDDEN_SHORTCUT">Forbidden Shortcut</option>
                    <option value="WEBCAM_DENIED">Webcam Denied</option>
                    <option value="SCREEN_SHARE_STOPPED">Screen Share Stopped</option>
                </select>
            </div>
            <div class="control-group">
                <label for="date-range">Date Range</label>
                <select id="date-range" onchange="updateReport()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="control-group custom-date-inputs" id="custom-date-inputs" style="display: none;">
                <div class="date-input-group">
                    <label for="start-date">From Date</label>
                    <input type="date" id="start-date" onchange="updateReport()">
                </div>
                <div class="date-input-group">
                    <label for="end-date">To Date</label>
                    <input type="date" id="end-date" onchange="updateReport()">
                </div>
            </div>
        </div>
        <div class="control-actions">
            <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
            <button class="btn btn-primary" id="refresh-btn" onclick="updateReport()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
        </div>
    </div>

    <!-- Alert Section for High-Risk Students -->
    <div class="alert-section" id="alert-section" style="display: none;">
        <div class="alert-card">
            <div class="alert-header">
                <i class="fas fa-exclamation-triangle alert-icon"></i>
                <span class="alert-title">High-Risk Students Detected</span>
            </div>
            <div class="alert-content" id="alert-content">
                <!-- Dynamic alert content -->
            </div>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="stat-card total-students">
                <div class="stat-number" id="total-students">Loading...</div>
                <div class="stat-label">Students Monitored</div>
                <div class="stat-change positive" id="students-change">Loading...</div>
            </div>
            <div class="stat-card total-violations">
                <div class="stat-number" id="total-violations">Loading...</div>
                <div class="stat-label">Total Violations</div>
                <div class="stat-change negative" id="violations-change">Loading...</div>
            </div>
            <div class="stat-card avg-violations">
                <div class="stat-number" id="avg-violations">Loading...</div>
                <div class="stat-label">Average per Student</div>
                <div class="stat-change neutral" id="avg-change">Loading...</div>
            </div>
            <div class="stat-card high-risk">
                <div class="stat-number" id="high-risk">Loading...</div>
                <div class="stat-label">High-Risk Students</div>
                <div class="stat-change negative" id="risk-change">Loading...</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Violations Timeline (Monthly)</div>
                <canvas id="timelineChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Violation Types Distribution</div>
                <canvas id="violationTypesChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-title">Violations by Assessment</div>
                <canvas id="assessmentChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-title">Risk Level Distribution</div>
                <canvas id="timeOfDayChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- Data Tables Section -->
        <div class="data-table-section">
            <div class="table-header">
                <div class="table-title">Student Behavior Overview</div>
                <div class="table-actions">
                    <button class="btn btn-success" onclick="exportTableData('behavior-table', 'student_behavior_overview')">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportTablePDF('behavior-table', 'Student Behavior Overview')">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
            <table id="behavior-table" class="data-table">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Total Violations</th>
                        <th>Looking Away</th>
                        <th>Tab Switch</th>
                        <th>Shortcuts</th>
                        <th>Other</th>
                        <th>Risk Level</th>
                        <th>Last Violation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="behavior-table-body">
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px;">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Individual Student Analysis (Hidden by default) -->
        <div class="data-table-section individual-analysis" id="individual-analysis" style="display: none; margin-top: 30px;">
            <div class="table-header">
                <div class="table-title">Individual Student Analysis - <span id="selected-student-name">Student Name</span></div>
                <div class="table-actions">
                    <button class="btn btn-secondary" onclick="hideIndividualAnalysis()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
            
            <!-- Individual Student Stats -->
            <div class="individual-stats-grid">
                <div class="individual-stat-card">
                    <div class="stat-number" id="ind-total-violations">0</div>
                    <div class="stat-label">Total Violations</div>
                </div>
                <div class="individual-stat-card">
                    <div class="stat-number" id="ind-exams-taken">0</div>
                    <div class="stat-label">Exams Taken</div>
                </div>
                <div class="individual-stat-card">
                    <div class="stat-number" id="ind-avg-per-exam">0</div>
                    <div class="stat-label">Avg. per Exam</div>
                </div>
                <div class="individual-stat-card">
                    <div class="stat-number" id="ind-worst-behavior">N/A</div>
                    <div class="stat-label">Most Common Type</div>
                </div>
            </div>

            <!-- Individual Student Detailed Timeline -->
            <div class="chart-container" style="margin-top: 20px;">
                <div class="chart-title">Individual Violation Timeline</div>
                <canvas id="individualTimelineChart" class="chart-canvas"></canvas>
            </div>

            <!-- Individual Violations Table -->
            <table id="individual-violations-table" class="data-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Assessment</th>
                        <th>Violation Type</th>
                        <th>Description</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="individual-violations-body">
                    <!-- Individual student violations will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
        <div class="export-info">
            Last updated: <strong id="last-updated">Loading...</strong>
        </div>
    </div>
</div>

<!-- Evidence Modal -->
<div id="evidence-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Evidence Viewer</h3>
            <span class="close" onclick="closeEvidenceModal()">&times;</span>
        </div>
        <div class="modal-body" id="evidence-modal-body">
            <!-- Evidence content will be loaded here -->
        </div>
    </div>
</div>

<style>
/* Additional CSS for Student Behavior Report */
.alert-section {
    margin: 20px;
    margin-bottom: 30px;
}

.alert-card {
    background: linear-gradient(135deg, #fef3cd 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.alert-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.alert-icon {
    color: #d97706;
    font-size: 1.5em;
    margin-right: 12px;
}

.alert-title {
    color: #92400e;
    font-size: 1.2em;
    font-weight: 600;
}

.alert-content {
    color: #78350f;
    line-height: 1.6;
}

.alert-content ul {
    margin: 10px 0;
    padding-left: 20px;
}

/* Statistics Cards */
.stat-card.total-students {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left: 4px solid #3b82f6;
}

.stat-card.total-students .stat-number { color: #1d4ed8; }
.stat-card.total-students .stat-label { color: #1e40af; }

.stat-card.total-violations {
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    border-left: 4px solid #ef4444;
}

.stat-card.total-violations .stat-number { color: #dc2626; }
.stat-card.total-violations .stat-label { color: #b91c1c; }

.stat-card.avg-violations {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
}

.stat-card.avg-violations .stat-number { color: #d97706; }
.stat-card.avg-violations .stat-label { color: #92400e; }

.stat-card.high-risk {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    border-left: 4px solid #8b5cf6;
}

.stat-card.high-risk .stat-number { color: #7c3aed; }
.stat-card.high-risk .stat-label { color: #6b21a8; }

/* Risk Level Badges */
.risk-low {
    background: #f0fdf4;
    color: #16a34a;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.risk-medium {
    background: #fef3c7;
    color: #d97706;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.risk-high {
    background: #fef2f2;
    color: #dc2626;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

.risk-critical {
    background: #1f2937;
    color: #ffffff;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.85em;
    font-weight: 600;
}

/* Violation Type Badges */
.violation-looking_away { color: #dc2626; font-weight: 600; }
.violation-tab_switch { color: #ea580c; font-weight: 600; }
.violation-forbidden_shortcut { color: #7c3aed; font-weight: 600; }
.violation-webcam_denied { color: #0891b2; font-weight: 600; }
.violation-screen_share_stopped { color: #65a30d; font-weight: 600; }

/* Severity Indicators */
.severity-low { color: #16a34a; }
.severity-medium { color: #d97706; }
.severity-high { color: #dc2626; }
.severity-critical { color: #7c2d12; font-weight: bold; }

/* Status Badges */
.status-pending {
    background: #fef3c7;
    color: #92400e;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.status-reviewed {
    background: #f0fdf4;
    color: #166534;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.status-dismissed {
    background: #fee2e2;
    color: #dc2626;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

/* Evidence buttons */
.evidence-btn {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    cursor: pointer;
    margin: 2px;
}

.evidence-btn:hover {
    background: #2563eb;
}

/* Individual Analysis Section */
.individual-analysis {
    border: 2px solid #3b82f6;
    border-radius: 12px;
    background: #f8fafc;
}

.individual-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
    margin: 20px;
}

.individual-stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.individual-stat-card .stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #1f2937;
    margin-bottom: 5px;
}

.individual-stat-card .stat-label {
    color: #6b7280;
    font-size: 0.9em;
}

/* UPDATED Custom date inputs - Better alignment */
.custom-date-inputs {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-top: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.date-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.date-input-group label {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
    margin-bottom: 0;
}

.date-input-group input {
    padding: 10px 12px;
    margin-bottom: 15px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    height: 42px;
    box-sizing: border-box;
    background: white;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.date-input-group input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.date-input-group input:hover {
    border-color: #9ca3af;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
}

.modal-header {
    background: #3b82f6;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

/* Evidence display */
.evidence-item {
    margin-bottom: 15px;
    text-align: center;
}

.evidence-item img {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.evidence-item video {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
}

.evidence-info {
    margin-top: 10px;
    color: #6b7280;
    font-size: 0.9em;
}

/* Actions column buttons */
.action-btn {
    background: none;
    border: 1px solid #d1d5db;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    margin: 2px;
    font-size: 0.8em;
}

.action-btn.view {
    color: #3b82f6;
    border-color: #3b82f6;
}

.action-btn.view:hover {
    background: #3b82f6;
    color: white;
}

.action-btn.evidence {
    color: #059669;
    border-color: #059669;
}

.action-btn.evidence:hover {
    background: #059669;
    color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .controls-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .individual-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    /* Mobile responsive for custom date inputs */
    .custom-date-inputs {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}

@media (max-width: 480px) {
    .custom-date-inputs {
        padding: 10px;
    }
    
    .date-input-group input {
        height: 40px;
        padding: 8px 10px;
    }
}
</style>

<script>
let timelineChart, violationTypesChart, assessmentChart, timeOfDayChart, individualTimelineChart;
let currentReportData = null;

// Initialize charts
function initCharts() {
    // Timeline Chart - Line chart showing violations per month
    const timelineCtx = document.getElementById('timelineChart').getContext('2d');
    timelineChart = new Chart(timelineCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Violations per Month',
                data: [],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Violations'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            }
        }
    });

    // Violation Types Chart - Pie chart
    const typesCtx = document.getElementById('violationTypesChart').getContext('2d');
    violationTypesChart = new Chart(typesCtx, {
        type: 'pie',
        data: {
            labels: ['Looking Away', 'Tab Switch', 'Forbidden Shortcut', 'Webcam Denied', 'Screen Share Stopped'],
            datasets: [{
                data: [0, 0, 0, 0, 0],
                backgroundColor: ['#dc2626', '#ea580c', '#7c3aed', '#0891b2', '#65a30d'],
                borderWidth: 3,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} violations (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Assessment Chart - Bar chart showing violations by assessment
    const assessmentCtx = document.getElementById('assessmentChart').getContext('2d');
    assessmentChart = new Chart(assessmentCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Violations by Assessment',
                data: [],
                backgroundColor: '#3b82f6',
                borderRadius: 6,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Violations'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Assessment Code'
                    }
                }
            }
        }
    });

    // Risk Level Chart - Doughnut chart showing distribution of risk levels
    const timeOfDayCtx = document.getElementById('timeOfDayChart').getContext('2d');
    timeOfDayChart = new Chart(timeOfDayCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#7c2d12'],
                borderWidth: 3,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} students (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Individual Timeline Chart
    const indTimelineCtx = document.getElementById('individualTimelineChart').getContext('2d');
    individualTimelineChart = new Chart(indTimelineCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Individual Violations',
                data: [],
                borderColor: '#7c3aed',
                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Violations'
                    }
                }
            }
        }
    });
}

// Update report based on filters
async function updateReport() {
    const studentFilter = document.getElementById('student-filter').value;
    const violationTypeFilter = document.getElementById('violation-type').value;
    const dateRangeFilter = document.getElementById('date-range').value;
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    // Show loading state
    showLoadingState();

    try {
        // Build API URL
        let apiUrl = `/api/reports/student-behavior?student=${studentFilter}&violation_type=${violationTypeFilter}&date_range=${dateRangeFilter}`;
        
        if (dateRangeFilter === 'custom' && startDate && endDate) {
            apiUrl += `&start_date=${startDate}&end_date=${endDate}`;
        }

        // Fetch data from backend
        const response = await fetch(apiUrl);
        const result = await response.json();

        if (result.success) {
            // Update charts with real data
            updateChartsWithData(result.data);
            
            // Update summary statistics
            updateSummaryStats(result.data.summary);
            
            // Update data tables
            updateBehaviorTable(result.data.students);
            // updateViolationsTable removed as requested
            
            // Update alerts
            updateAlerts(result.data.high_risk_students);
            
            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
            // Store data for export functions
            currentReportData = {
                data: result.data,
                summary: result.data.summary,
                filters: result.filters
            };
            
        } else {
            console.error('API Error:', result.error);
            Swal.fire('Error', 'Error loading report data: ' + result.error, 'error');
        }

    } catch (error) {
        console.error('Network Error:', error);
        Swal.fire('Error', 'Error connecting to server. Please try again.', 'error');
    } finally {
        hideLoadingState();
    }
}

// Show loading state
function showLoadingState() {
    const refreshBtn = document.getElementById('refresh-btn');
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    refreshBtn.disabled = true;
    document.querySelector('.stats-section').classList.add('loading');
}

// Hide loading state
function hideLoadingState() {
    const refreshBtn = document.getElementById('refresh-btn');
    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
    refreshBtn.disabled = false;
    document.querySelector('.stats-section').classList.remove('loading');
}

// Update charts with real data from API
function updateChartsWithData(data) {
    // Update timeline chart
    if (data.timeline) {
        timelineChart.data.labels = data.timeline.labels;
        timelineChart.data.datasets[0].data = data.timeline.violations;
        timelineChart.update();
    }

    // Update violation types chart
    if (data.violation_types) {
        violationTypesChart.data.datasets[0].data = [
            data.violation_types.looking_away || 0,
            data.violation_types.tab_switch || 0,
            data.violation_types.forbidden_shortcut || 0,
           data.violation_types.webcam_denied || 0,
           data.violation_types.screen_share_stopped || 0
       ];
       violationTypesChart.update();
   }

   // Update assessment chart
   if (data.assessments) {
       assessmentChart.data.labels = data.assessments.labels;
       assessmentChart.data.datasets[0].data = data.assessments.violations;
       assessmentChart.update();
   }

   // Update risk level chart
   if (data.risk_levels) {
       timeOfDayChart.data.datasets[0].data = [
           data.risk_levels.low || 0,
           data.risk_levels.medium || 0,
           data.risk_levels.high || 0,
           data.risk_levels.critical || 0
       ];
       timeOfDayChart.update();
   }
}

// Update summary statistics cards
function updateSummaryStats(summary) {
   if (!summary) return;
   
   document.getElementById('total-students').textContent = summary.total_students || 0;
   document.getElementById('total-violations').textContent = summary.total_violations || 0;
   document.getElementById('avg-violations').textContent = (summary.avg_violations || 0).toFixed(1);
   document.getElementById('high-risk').textContent = summary.high_risk_students || 0;

   // Update change indicators
   document.getElementById('students-change').textContent = summary.total_students + ' monitored';
   document.getElementById('violations-change').textContent = summary.total_violations > 0 ? 'Violations detected' : 'No violations';
   document.getElementById('avg-change').textContent = summary.avg_violations > 3 ? 'Above average' : 'Within normal range';
   document.getElementById('risk-change').textContent = summary.high_risk_students > 0 ? 'Attention required' : 'All students safe';
}

// Update behavior overview table
function updateBehaviorTable(studentsData) {
   const tbody = document.getElementById('behavior-table-body');
   tbody.innerHTML = '';

   if (!studentsData || studentsData.length === 0) {
       tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No behavior data available</td></tr>';
       return;
   }

   studentsData.forEach(student => {
       const row = document.createElement('tr');
       
       // Calculate risk level
       const totalViolations = student.total_violations || 0;
       let riskLevel = 'Low';
       let riskClass = 'risk-low';
       
       if (totalViolations >= 15) {
           riskLevel = 'Critical';
           riskClass = 'risk-critical';
       } else if (totalViolations >= 10) {
           riskLevel = 'High';
           riskClass = 'risk-high';
       } else if (totalViolations >= 5) {
           riskLevel = 'Medium';
           riskClass = 'risk-medium';
       }

        // Format last violation date
        let lastViolation = 'Never';
        if (student.last_violation) {
            try {
                let dateValue = student.last_violation;
                
                // Handle MongoDB date object
                if (typeof dateValue === 'object' && dateValue.$date) {
                    dateValue = dateValue.$date;
                }
                
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    // Use UTC date to avoid timezone conversion
                    const year = date.getUTCFullYear();
                    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                    const day = date.getUTCDate().toString().padStart(2, '0');
                    lastViolation = `${day}/${month}/${year}`;
                }
            } catch (e) {
                lastViolation = 'Never';
            }
        }
       
       row.innerHTML = `
           <td><strong>${student.student_id}</strong></td>
           <td><strong>${student.student_name}</strong></td>
           <td><strong>${totalViolations}</strong></td>
           <td>${student.looking_away || 0}</td>
           <td>${student.tab_switch || 0}</td>
           <td>${student.forbidden_shortcut || 0}</td>
           <td>${(student.webcam_denied || 0) + (student.screen_share_stopped || 0)}</td>
           <td><span class="${riskClass}">${riskLevel}</span></td>
           <td>${lastViolation}</td>
           <td>
               <button class="btn btn-primary" onclick="showIndividualAnalysis('${student.student_id}')">
                   <i class="fas fa-eye"></i> View
               </button>
           </td>
       `;
       
       tbody.appendChild(row);
   });
}

// Update alerts section
function updateAlerts(highRiskStudents) {
   const alertSection = document.getElementById('alert-section');
   const alertContent = document.getElementById('alert-content');
   
   if (!highRiskStudents || highRiskStudents.length === 0) {
       alertSection.style.display = 'none';
       return;
   }
   
   const totalHighRisk = highRiskStudents.length;
   
   alertContent.innerHTML = `
       <p><strong>${totalHighRisk} students</strong> have been flagged as high-risk based on their violation patterns.</p>
       <ul>
           ${highRiskStudents.slice(0, 5).map(student => 
               `<li><strong>${student.student_name}</strong> (${student.student_id}): ${student.total_violations} violations`
           ).join('')}
           ${highRiskStudents.length > 5 ? '<li><em>...and ' + (highRiskStudents.length - 5) + ' more students</em></li>' : ''}
       </ul>
       <p>Recommended action: Review individual student behavior and consider additional monitoring.</p>
   `;
   
   alertSection.style.display = 'block';
}

// Show individual student analysis
async function showIndividualAnalysis(studentId) {
   try {
       // Fetch individual student data
       const response = await fetch(`/api/reports/student-behavior/individual?student_id=${studentId}`);
       const result = await response.json();

       if (result.success) {
           const student = result.data;
           
           // Update individual analysis section
           document.getElementById('selected-student-name').textContent = student.student_name;
           document.getElementById('ind-total-violations').textContent = student.total_violations || 0;
           document.getElementById('ind-exams-taken').textContent = student.exams_taken || 0;
           document.getElementById('ind-avg-per-exam').textContent = (student.avg_per_exam || 0).toFixed(1);
           document.getElementById('ind-worst-behavior').textContent = student.most_common_type || 'N/A';

           // Update individual timeline chart
           if (student.timeline) {
               individualTimelineChart.data.labels = student.timeline.labels;
               individualTimelineChart.data.datasets[0].data = student.timeline.violations;
               individualTimelineChart.update();
           }

           // Update individual violations table
           updateIndividualViolationsTable(student.violations);

           // Show the individual analysis section
           document.getElementById('individual-analysis').style.display = 'block';
           
           // Scroll to the section
           document.getElementById('individual-analysis').scrollIntoView({ behavior: 'smooth' });

       } else {
           Swal.fire('Error', 'Error loading individual student data: ' + result.error, 'error');
       }
   } catch (error) {
       console.error('Error fetching individual student data:', error);
       Swal.fire('Error', 'Error connecting to server. Please try again.', 'error');
   }
}

// Update individual violations table
function updateIndividualViolationsTable(violations) {
   const tbody = document.getElementById('individual-violations-body');
   tbody.innerHTML = '';

   if (!violations || violations.length === 0) {
       tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No violations recorded for this student</td></tr>';
       return;
   }

   violations.forEach(violation => {
       const row = document.createElement('tr');
       
       // Format timestamp properly
        let timestamp = 'Invalid Date';

        if (violation.timestamp) {
            try {
                let dateValue = violation.timestamp;
                
                // Check if it's a MongoDB date object structure
                if (typeof dateValue === 'object' && dateValue.$date) {
                    dateValue = dateValue.$date;
                }
                
                // Parse the date
                const date = new Date(dateValue);
                
                if (!isNaN(date.getTime())) {
                    // Use UTC to avoid timezone conversion
                    const year = date.getUTCFullYear();
                    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                    const day = date.getUTCDate().toString().padStart(2, '0');
                    const hours = date.getUTCHours().toString().padStart(2, '0');
                    const minutes = date.getUTCMinutes().toString().padStart(2, '0');
                    const seconds = date.getUTCSeconds().toString().padStart(2, '0');
                    
                    timestamp = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                } else {
                    timestamp = 'Date Parse Error';
                }
            } catch (e) {
                console.error('Error parsing timestamp:', violation.timestamp, e);
                timestamp = 'Date Error';
            }
        }

       // Status badge
       const statusClass = `status-${violation.status || 'pending'}`;
       const statusText = (violation.status || 'pending').charAt(0).toUpperCase() + 
                         (violation.status || 'pending').slice(1);

       row.innerHTML = `
           <td>${timestamp}</td>
           <td>${violation.assessment_code}</td>
           <td>${violation.violation_type}</td>
           <td>${violation.description}</td>
           <td><span class="${statusClass}">${statusText}</span></td>
       `;
       
       tbody.appendChild(row);
   });
}

// Hide individual analysis
function hideIndividualAnalysis() {
   document.getElementById('individual-analysis').style.display = 'none';
}

// View evidence modal
async function viewEvidence(violationId) {
   try {
       const response = await fetch(`/api/evidence/${violationId}`);
       const result = await response.json();

       if (result.success) {
           const evidence = result.data;
           const modalBody = document.getElementById('evidence-modal-body');
           
           modalBody.innerHTML = '';
           
           if (evidence.files && evidence.files.length > 0) {
               evidence.files.forEach(file => {
                   const evidenceItem = document.createElement('div');
                   evidenceItem.className = 'evidence-item';
                   
                   if (file.type === 'screenshot') {
                       evidenceItem.innerHTML = `
                           <img src="${file.url}" alt="Screenshot Evidence" />
                           <div class="evidence-info">
                               Screenshot - ${file.filename}<br>
                               Size: ${(file.size / 1024).toFixed(1)} KB
                           </div>
                       `;
                   } else if (file.type === 'video') {
                       evidenceItem.innerHTML = `
                           <video controls>
                               <source src="${file.url}" type="video/webm">
                               Your browser does not support the video tag.
                           </video>
                           <div class="evidence-info">
                               Video Evidence - ${file.filename}<br>
                               Size: ${(file.size / 1024).toFixed(1)} KB
                           </div>
                       `;
                   }
                   
                   modalBody.appendChild(evidenceItem);
               });
           } else {
               modalBody.innerHTML = '<p>No evidence files available for this violation.</p>';
           }
           
           // Show modal
           document.getElementById('evidence-modal').style.display = 'block';
           
       } else {
           Swal.fire('Error', 'Error loading evidence: ' + result.error, 'error');
       }
   } catch (error) {
       console.error('Error fetching evidence:', error);
       Swal.fire('Error', 'Error connecting to server. Please try again.', 'error');
   }
}

// Close evidence modal
function closeEvidenceModal() {
   document.getElementById('evidence-modal').style.display = 'none';
}

// View student evidence
function viewStudentEvidence(studentId) {
   // Implementation for viewing all evidence for a specific student
   Swal.fire('Info', `Feature to view all evidence for student ${studentId} - Coming soon!`, 'info');
}

// Review violation
function reviewViolation(violationId) {
   // Implementation for reviewing/updating violation status
   Swal.fire('Info', `Feature to review violation ${violationId} - Coming soon!`, 'info');
}

// Handle date range changes
document.getElementById('date-range').addEventListener('change', function() {
   const customInputs = document.getElementById('custom-date-inputs');
   if (this.value === 'custom') {
       customInputs.style.display = 'block';
   } else {
       customInputs.style.display = 'none';
   }
});

// Reset all filters
function resetFilters() {
   document.getElementById('student-filter').value = 'all';
   document.getElementById('violation-type').value = 'all';
   document.getElementById('date-range').value = 'all';
   document.getElementById('custom-date-inputs').style.display = 'none';
   document.getElementById('start-date').value = '';
   document.getElementById('end-date').value = '';
   hideIndividualAnalysis();
   updateReport();
}

// Export table data as CSV
function exportTableData(tableId, filename) {
   const table = document.getElementById(tableId);
   const rows = Array.from(table.querySelectorAll('tr'));
   
   let csv = '';
   rows.forEach(row => {
       const cols = Array.from(row.querySelectorAll('th, td'));
       const csvRow = cols.map(col => `"${col.textContent.trim()}"`).join(',');
       csv += csvRow + '\n';
   });
   
   const blob = new Blob([csv], { type: 'text/csv' });
   const url = window.URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
   a.click();
   window.URL.revokeObjectURL(url);
}

// Export table as PDF
function exportTablePDF(tableId, title) {
   if (!currentReportData) {
       Swal.fire('Warning', 'No data available to export. Please wait for the report to load completely, then try again.', 'warning');
       return;
   }

   try {
       // Create print-friendly version in new tab
       const printWindow = window.open('', '_blank');
       
       if (!printWindow) {
           Swal.fire('Error', 'Unable to open print window. Please check your popup blocker.', 'error');
           return;
       }

       const { data, summary, filters } = currentReportData;
       
       // Generate HTML content for PDF
       const htmlContent = `
<!DOCTYPE html>
<html>
<head>
   <title>${title}</title>
   <style>
       body { font-family: Arial, sans-serif; margin: 20px; }
       .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
       .header h1 { color: #333; margin: 0; }
       .info { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
       .summary { margin: 20px 0; }
       .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
       .summary-item { padding: 15px; border: 1px solid #ddd; text-align: center; background: #f9f9f9; }
       .summary-item h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
       .summary-item .value { font-size: 20px; font-weight: bold; margin: 0; }
       table { width: 100%; border-collapse: collapse; margin: 20px 0; }
       th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
       th { background: #3b82f6; color: white; font-weight: bold; }
       tr:nth-child(even) { background: #f9f9f9; }
       .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #666; }
       .risk-high { color: #dc2626; font-weight: bold; }
       .risk-medium { color: #d97706; font-weight: bold; }
       .risk-low { color: #16a34a; }
   </style>
</head>
<body>
   <div class="header">
       <h1>Student Behavior Analytics Report</h1>
       <p><strong>${title}</strong></p>
       <p>Generated: ${new Date().toLocaleString()}</p>
   </div>
   
   <div class="info">
       <p><strong>Student Filter:</strong> ${filters.student === 'all' ? 'All Students' : filters.student}</p>
       <p><strong>Violation Type:</strong> ${filters.violation_type === 'all' ? 'All Types' : filters.violation_type}</p>
       <p><strong>Date Range:</strong> ${filters.date_range === 'all' ? 'All Time' : filters.date_range}</p>
   </div>
   
   <div class="summary">
       <h2>Summary Statistics</h2>
       <div class="summary-grid">
           <div class="summary-item">
               <h3>Students Monitored</h3>
               <p class="value">${summary.total_students || 0}</p>
           </div>
           <div class="summary-item">
               <h3>Total Violations</h3>
               <p class="value">${summary.total_violations || 0}</p>
           </div>
           <div class="summary-item">
               <h3>Average per Student</h3>
               <p class="value">${(summary.avg_violations || 0).toFixed(1)}</p>
           </div>
           <div class="summary-item">
               <h3>High-Risk Students</h3>
               <p class="value">${summary.high_risk_students || 0}</p>
           </div>
       </div>
   </div>
   
   <div class="details">
       <h2>${title}</h2>
       ${generatePDFTableContent(tableId, data)}
   </div>
   
   <div class="footer">
       <p>Generated by Online Exam Platform - Student Behavior Analytics</p>
   </div>
</body>
</html>`;

       // Write content and set up print
       printWindow.document.write(htmlContent);
       printWindow.document.close();
       
       // Wait and then print
       setTimeout(() => {
           printWindow.print();
       }, 1000);
       
   } catch (error) {
       console.error('PDF Export Error:', error);
       Swal.fire('Error', 'Failed to generate PDF: ' + error.message, 'error');
   }
}

// Generate PDF table content based on table type
function generatePDFTableContent(tableId, data) {
   if (tableId === 'behavior-table') {
       const students = data.students || [];
       let tableHTML = `
           <table>
               <thead>
                   <tr>
                       <th>Student ID</th>
                       <th>Student Name</th>
                       <th>Total Violations</th>
                       <th>Looking Away</th>
                       <th>Tab Switch</th>
                       <th>Shortcuts</th>
                       <th>Other</th>
                       <th>Risk Level</th>
                   </tr>
               </thead>
               <tbody>`;
       
       students.forEach(student => {
           const totalViolations = student.total_violations || 0;
           let riskLevel = 'Low';
           let riskClass = 'risk-low';
           
           if (totalViolations >= 15) {
               riskLevel = 'Critical';
               riskClass = 'risk-critical';
           } else if (totalViolations >= 10) {
               riskLevel = 'High';
               riskClass = 'risk-high';
           } else if (totalViolations >= 5) {
               riskLevel = 'Medium';
               riskClass = 'risk-medium';
           }
           
           tableHTML += `
               <tr>
                   <td>${student.student_id}</td>
                   <td>${student.student_name}</td>
                   <td><strong>${totalViolations}</strong></td>
                   <td>${student.looking_away || 0}</td>
                   <td>${student.tab_switch || 0}</td>
                   <td>${student.forbidden_shortcut || 0}</td>
                   <td>${(student.webcam_denied || 0) + (student.screen_share_stopped || 0)}</td>
                   <td><span class="${riskClass}">${riskLevel}</span></td>
               </tr>`;
       });
       
       tableHTML += '</tbody></table>';
       return tableHTML;
   }
   
   // Add other table types as needed
   return '<p>Table data not available for PDF export.</p>';
}

// Export evidence package
function exportEvidencePackage() {
   Swal.fire('Info', 'Evidence package export feature - Coming soon!', 'info');
}

// Export individual student report
function exportIndividualReport() {
   Swal.fire('Info', 'Individual student report export - Coming soon!', 'info');
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
   initCharts();
   loadStudentOptions();
   updateReport();
});

// Load student options for filter
async function loadStudentOptions() {
   try {
       const response = await fetch('/api/students/list');
       const result = await response.json();
       
       if (result.success) {
           const select = document.getElementById('student-filter');
           const allOption = select.querySelector('option[value="all"]');
           select.innerHTML = '';
           select.appendChild(allOption);
           
           result.students.forEach(student => {
               const option = document.createElement('option');
               option.value = student.student_id;
               option.textContent = `${student.student_id} - ${student.name}`;
               select.appendChild(option);
           });
       }
   } catch (error) {
       console.error('Error loading student options:', error);
   }
}

// Close modal when clicking outside
window.onclick = function(event) {
   const modal = document.getElementById('evidence-modal');
   if (event.target == modal) {
       modal.style.display = 'none';
   }
}
</script>

{% endblock %}