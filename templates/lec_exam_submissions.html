{% extends 'base_lecdashboard.html' %}
{% block title %}Assessment Submissions{% endblock %}
{% block breadcrumb %}Examinations > Submissions > {{ assessment.assessment_code }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/useredit.css') }}">
<h2 style="margin-left: 20px;">Submissions for {{ assessment.assessment_code }} - {{ assessment.title }}</h2>
<hr style="width: 100%;">
<a href="{{ url_for('lecturer_submission_overview') }}" class="btn-reset" style="float: left; margin-top: 10px; margin-bottom: 15px;">‚Üê Back</a>


<table class="studentList">
  <thead>
    <tr>
      <th>No.</th>
      <th>Student ID</th>
      <th>Name</th>
      <th>Course</th>
      <th>Filename</th>
      <th>Submitted At</th>
      <th>View</th>
      <th>Resubmission Status</th>
      <th>Plagiarism</th>
    </tr>
  </thead>
  <tbody>
    {% for s in submissions %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ s.student_id }}</td>
      <td>{{ s.student_name }}</td>
      <td>{{ s.student_course }}</td>
      <td style="max-width: 200px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; cursor: help;" 
          title="{{ s.filename }}">
          {{ s.filename }}
      </td>
      <td>{{ s.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
      <td>
        <a href="{{ url_for('static', filename='uploads/submissions/' + s.filename) }}" class="btn-download" target="_blank">
          View
        </a>
      </td>
    <td>
      {% if s.status %}
        {% set bg_color = (
          '#ffc107' if s.status == 'Pending' else
          '#28a745' if s.status == 'Approved' else
          'red' if s.status == 'Rejected' else
          '#6c757d'
        ) %}
        <a href="{{ url_for('lecturer_view_resubmission', submission_id=s._id) }}"
          class="btn-request"
          style="cursor: pointer; background-color: {{ bg_color }}; color: white;">
          {{ s.status }}
        </a>
      {% else %}
        <span style="color: #999;">-</span>
      {% endif %}
    </td>
    <td>
      {% if s.plagiarism_score is defined %}
        {% set bg_color = (
          'red' if s.plagiarism_score > 30 else
          'green'
        ) %}
        <a href="{{ url_for('lecturer_view_plagiarism_report', submission_id=s._id) }}"
          class="btn-request"
          style="cursor: pointer; background-color: {{ bg_color }}; color: white;">
          {{ s.plagiarism_score + s.quotes_score }}%
        </a>
      {% else %}
        <button type="button" 
                class="btn-request plagiarism-check-btn" 
                data-submission-id="{{ s._id }}"
                onclick="startPlagiarismCheck('{{ s._id }}')">
          <span class="btn-text">Check</span>
          <span class="btn-spinner" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i> Checking...
          </span>
        </button>
      {% endif %}
    </td>
    </tr>
    {% else %}
    <tr><td colspan="8" style="text-align:center;">No submissions found.</td></tr>
    {% endfor %}
  </tbody>
</table>

<style>
  .btn-download {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    padding: 5px 10px;
    text-decoration: none;
    cursor: pointer;
  }

  .btn-download:hover {
    background-color: #0056b3;
  }

  .btn-reset {
    background-color: #6c757d;
    color: white;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    padding: 6px 14px;
    text-decoration: none;
  }

  .btn-request {
    font-size: 14px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 6px;
    display: inline-block;
    text-decoration: none;
    cursor: pointer;
  }

  .studentList th, .studentList td {
    padding: 10px;
    border: 1px solid #ccc;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let checkingSubmissions = new Set();

function startPlagiarismCheck(submissionId) {
    if (checkingSubmissions.has(submissionId)) {
        return; // Already checking
    }
    
    checkingSubmissions.add(submissionId);
    const button = document.querySelector(`[data-submission-id="${submissionId}"]`);
    const btnText = button.querySelector('.btn-text');
    const btnSpinner = button.querySelector('.btn-spinner');
    
    // Show loading state
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline';
    button.disabled = true;
    
    // Show initial alert
    Swal.fire({
        title: 'Starting Plagiarism Check',
        text: 'Submitting document to plagiarism API...',
        icon: 'info',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    // Start the check
    fetch(`/lecturer/plagiarism/start/${submissionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for status
            pollPlagiarismStatus(submissionId);
        } else {
            handlePlagiarismError(submissionId, data.error);
        }
    })
    .catch(error => {
        handlePlagiarismError(submissionId, 'Network error: ' + error.message);
    });
}

function pollPlagiarismStatus(submissionId) {
    let pollCount = 0;
    const maxPolls = 60; // 10 minutes max (60 * 10 seconds)
    
    const pollInterval = setInterval(() => {
        pollCount++;
        
        // Update progress message
        Swal.update({
            title: 'Processing Document',
            text: `Analyzing for plagiarism... (${pollCount * 10}s)`,
            icon: 'info'
        });
        
        fetch(`/lecturer/plagiarism/status/${submissionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    handlePlagiarismComplete(submissionId, data);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    handlePlagiarismError(submissionId, data.error || 'Processing failed');
                } else if (data.status === 'processing') {
                    // Continue polling
                    if (pollCount >= maxPolls) {
                        clearInterval(pollInterval);
                        handlePlagiarismError(submissionId, 'Timeout: Processing took too long');
                    }
                } else {
                    // Unknown status, continue polling
                }
            } else {
                clearInterval(pollInterval);
                handlePlagiarismError(submissionId, data.error);
            }
        })
        .catch(error => {
            clearInterval(pollInterval);
            handlePlagiarismError(submissionId, 'Status check failed: ' + error.message);
        });
    }, 10000); // Poll every 10 seconds
}

function handlePlagiarismComplete(submissionId, data) {
    checkingSubmissions.delete(submissionId);
    
    const bgColor = data.total_score > 30 ? 'red' : 'green';
    
    Swal.fire({
        title: 'Plagiarism Check Complete!',
        html: `
            <div style="font-size: 16px; margin: 10px 0;">
                <strong>Total Score: ${data.total_score}%</strong><br>
                <small>Plagiarism: ${data.plagiarism_score}% | Quotes: ${data.quotes_score}%</small>
            </div>
        `,
        icon: data.total_score > 30 ? 'warning' : 'success',
        confirmButtonText: 'View Report'
    }).then((result) => {
        if (result.isConfirmed) {
            // Redirect to report
            window.location.href = `/lecturer/plagiarism/report/${submissionId}`;
        } else {
            // Just reload to show updated results
            window.location.reload();
        }
    });
}

function handlePlagiarismError(submissionId, errorMessage) {
    checkingSubmissions.delete(submissionId);
    
    const button = document.querySelector(`[data-submission-id="${submissionId}"]`);
    const btnText = button.querySelector('.btn-text');
    const btnSpinner = button.querySelector('.btn-spinner');
    
    // Reset button state
    btnText.style.display = 'inline';
    btnSpinner.style.display = 'none';
    button.disabled = false;
    
    Swal.fire({
        title: 'Plagiarism Check Failed',
        text: errorMessage,
        icon: 'error',
        confirmButtonText: 'Try Again'
    });
}
</script>
{% endblock %}
